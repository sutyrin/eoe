---
phase: 05-composition-canvas-offline-support
plan: 05
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03", "05-04"]
duration: 2h
autonomous: true
files_modified:
  - portfolio/src/styles/canvas.css
  - portfolio/src/components/CompositionCanvas.astro
  - portfolio/src/scripts/atom-node.tsx
  - portfolio/src/pages/mobile/compose.astro
  - portfolio/astro.config.mjs
  - portfolio/src/components/OfflineIndicator.astro

must_haves:
  truths:
    - "Touch targets for node handles are 48px tap radius (not the visual 10px dot)"
    - "Edge tap area is 24px radius for selecting/tapping edges on mobile"
    - "iOS grey rectangle fix applied: -webkit-tap-highlight-color: transparent on all canvas elements"
    - "Canvas does not conflict with page scroll (touch-action: none on container)"
    - "React Flow panOnDrag=[1], zoomOnPinch=true, panOnScroll=false confirmed in production build"
    - "Total mobile bundle (JS) is under 1.2MB gzipped"
    - "Add-atom flow completes in under 500ms (cold) or 200ms (warm)"
    - "Offline indicator shows 'X compositions not synced' count for Phase 6 preparation"
    - "All Phase 5 features work offline after first visit"
    - "Build succeeds and all pages render without errors"
  artifacts:
    - path: "portfolio/src/styles/canvas.css"
      provides: "Updated canvas styles with enlarged touch targets and iOS fixes"
      contains: "48px"
    - path: "portfolio/src/components/CompositionCanvas.astro"
      provides: "Optimized React Flow canvas with performance monitoring"
      contains: "performance"
  key_links:
    - from: "portfolio/src/components/OfflineIndicator.astro"
      to: "portfolio/src/scripts/composition-store.ts"
      via: "import { getUnsyncedCount }"
      pattern: "getUnsyncedCount"
---

<objective>
Optimize touch interaction, verify bundle size, test offline support, and perform end-to-end verification of all Phase 5 features. After this plan, the composition canvas is production-ready for mobile use: touch targets meet accessibility standards, gestures are responsive, the bundle is within performance budgets, and everything works offline.

Purpose: Without touch optimization, the canvas is technically functional but frustrating on a 6" phone (small tap targets, scroll conflicts, iOS rendering bugs). This plan ensures the composition experience feels natural on mobile. The verification step confirms all Phase 5 requirements are met before declaring the phase complete.
Output: Touch-optimized canvas, verified bundle size, offline confirmation, and full Phase 5 requirement verification.
</objective>

<execution_context>
@/home/pavel/.claude/get-shit-done/workflows/execute-plan.md
@/home/pavel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-composition-canvas-offline-support/05-RESEARCH.md
@.planning/phases/05-composition-canvas-offline-support/05-01-PLAN.md
@.planning/phases/05-composition-canvas-offline-support/05-02-PLAN.md
@.planning/phases/05-composition-canvas-offline-support/05-03-PLAN.md
@.planning/phases/05-composition-canvas-offline-support/05-04-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enlarge touch targets for handles and edges</name>
  <files>
    portfolio/src/scripts/atom-node.tsx
    portfolio/src/styles/canvas.css
  </files>
  <action>
Increase the touch-interactive areas on node handles and edges to meet mobile accessibility standards. The visual appearance stays compact (10px dots, 2px edges) but the touch-sensitive area is much larger.

**Update portfolio/src/scripts/atom-node.tsx:**

Increase handle hit areas. React Flow Handle component supports a `style` prop. The visual dot is 10px but the interactive area should be 48px. Use a transparent padding area around each handle.

For each Handle component in atom-node.tsx, update the style:

```tsx
{/* Input handle (left) - 48px touch target */}
<Handle
  type="target"
  position={Position.Left}
  id={`${handleId}-in`}
  style={{
    width: 12,
    height: 12,
    background: color,
    border: '2px solid #0a0a0a',
    left: -6,
    // Touch target enlargement via pseudo-element is handled in CSS
  }}
/>

{/* Output handle (right) - 48px touch target */}
<Handle
  type="source"
  position={Position.Right}
  id={`${handleId}-out`}
  style={{
    width: 12,
    height: 12,
    background: color,
    border: '2px solid #0a0a0a',
    right: -6,
  }}
/>
```

**Update portfolio/src/styles/canvas.css:**

Add CSS to enlarge the touch target area for handles and edges without changing visual size:

```css
/* Enlarge handle touch targets to 48px (Apple HIG minimum) */
.react-flow__handle {
  /* Visual size stays small, but touch area is large */
  position: relative;
}

.react-flow__handle::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 48px;
  height: 48px;
  border-radius: 24px;
  /* Transparent but still captures touches */
}

/* Enlarge edge tap area to 24px radius */
.react-flow__edge {
  cursor: pointer;
}

.react-flow__edge-interaction {
  stroke-width: 48 !important; /* Wide invisible hit area */
  stroke: transparent !important;
}

/* Prevent accidental selection during drag */
.react-flow__node {
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}

/* Smooth node dragging */
.react-flow__node.dragging {
  z-index: 10;
  opacity: 0.9;
}

/* Selected node highlight */
.react-flow__node.selected {
  /* No default blue outline - use our own */
}

.react-flow__node.selected > div {
  box-shadow: 0 0 0 2px #6bb5ff;
}
```

This approach:
- Handle visual dot: 12px diameter (visible on screen)
- Handle touch target: 48px diameter via ::after pseudo-element (invisible)
- Edge visual: 2px stroke width
- Edge touch target: 48px stroke width via .react-flow__edge-interaction
- Prevents text selection during drag operations
  </action>
  <verify>
1. Handle touch targets are 48px (verify by tapping near but not on the visible dot)
2. Edge tap area is at least 24px radius
3. No accidental text selection during node drag
4. Selected node has blue highlight ring
5. Dragging node shows slightly transparent with higher z-index
6. `cd portfolio && npm run build` succeeds
  </verify>
  <done>
Touch targets enlarged: node handles have 48px invisible touch area via CSS ::after, edge interaction stroke widened to 48px for easy mobile tapping. Selection prevention and drag visual feedback added. Meets Apple HIG 44px minimum with 48px targets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply iOS-specific CSS fixes and gesture tuning</name>
  <files>
    portfolio/src/styles/canvas.css
    portfolio/src/components/CompositionCanvas.astro
  </files>
  <action>
Apply iOS Safari-specific fixes and fine-tune gesture behavior for mobile.

**Update portfolio/src/styles/canvas.css:**

Add iOS-specific fixes at the top of the file:

```css
/* iOS Safari fixes for canvas */

/* Prevent grey highlight rectangles on touch (iOS Safari bug) */
/* Reference: https://cables.gl/docs/faq/embedding/mobile_grey_rects/grey_rectangles_on_ios */
.react-flow,
.react-flow *,
.canvas-container,
.canvas-container * {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

/* Prevent iOS elastic scroll (bounce) on canvas */
.canvas-container {
  touch-action: none;
  overflow: hidden;
  /* Prevent iOS overscroll */
  overscroll-behavior: none;
  -webkit-overflow-scrolling: auto; /* Disable momentum scroll on canvas */
}

/* Prevent 300ms tap delay on iOS */
.react-flow__node,
.react-flow__edge,
.compose-fab,
.toolbar-btn,
.picker-atom-item {
  touch-action: manipulation;
}

/* Fix for iOS Safari zoom on double-tap */
.react-flow__pane {
  touch-action: none;
}

/* Ensure canvas fills viewport without gaps on iOS */
.canvas-container {
  position: fixed;
  top: calc(48px + 40px); /* header + toolbar */
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: auto; /* Replaces calc-based height for iOS compat */
}
```

**Update portfolio/src/components/CompositionCanvas.astro:**

Verify React Flow mobile config is correct in the createElement props:

```typescript
{
  panOnDrag: [1],           // Array with mouse button index 0 = left/touch
  zoomOnPinch: true,        // Pinch-to-zoom on mobile
  panOnScroll: false,       // Prevent scroll conflicts
  zoomOnScroll: false,      // Prevent accidental zoom (mobile has pinch)
  zoomOnDoubleClick: false, // Prevent accidental zoom on double-tap
  nodesDraggable: true,     // Allow node repositioning
  nodesConnectable: false,  // Routing via dropdown UI only (not drag-to-connect)
  selectNodesOnDrag: false, // Don't select when dragging (avoids blue outline flicker)
  minZoom: 0.5,
  maxZoom: 2,
  defaultViewport: { x: 0, y: 0, zoom: 1 },
  fitView: true,
  fitViewOptions: { padding: 0.3 },
  proOptions: { hideAttribution: true },
}
```

Add `selectNodesOnDrag: false` if not already present (prevents selection UI flicker during drag on mobile).
  </action>
  <verify>
1. No grey highlight rectangles on iOS Safari touch
2. Canvas does not bounce/elastic scroll on iOS
3. No 300ms tap delay on interactive elements
4. Double-tap does not zoom canvas
5. Canvas fills viewport correctly on iOS (no gap at bottom)
6. Pinch-to-zoom works smoothly
7. Single-finger pan works on canvas background
8. Node dragging is smooth (no jitter)
9. `cd portfolio && npm run build` succeeds
  </verify>
  <done>
iOS Safari fixes applied: grey rectangle prevention, elastic scroll prevention, 300ms tap delay elimination, double-tap zoom disabled, canvas viewport fixed positioning for iOS compatibility. React Flow config verified with selectNodesOnDrag=false for smooth mobile UX.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend offline indicator for composition sync status</name>
  <files>
    portfolio/src/components/OfflineIndicator.astro
  </files>
  <action>
Update the offline indicator to show composition sync status, preparing for Phase 6 cloud sync. This shows "X compositions not synced" when compositions have synced=false.

**Update portfolio/src/components/OfflineIndicator.astro:**

Add a third indicator element for sync status:

```html
<div id="sync-status" class="sync-status" style="display: none;">
  <span class="sync-dot"></span>
  <span class="sync-text"></span>
</div>
```

Add script logic to check unsynced composition count:

```typescript
// Check unsynced compositions (Phase 6 preparation)
async function checkSyncStatus() {
  try {
    const { getUnsyncedCount } = await import('../scripts/composition-store');
    const count = await getUnsyncedCount();
    const syncEl = document.getElementById('sync-status');
    const syncText = syncEl?.querySelector('.sync-text');

    if (syncEl && syncText) {
      if (count > 0) {
        syncText.textContent = `${count} composition${count !== 1 ? 's' : ''} not synced`;
        syncEl.style.display = 'flex';
      } else {
        syncEl.style.display = 'none';
      }
    }
  } catch {
    // Composition store may not be initialized yet
  }
}

// Check sync status periodically (every 30 seconds)
setInterval(checkSyncStatus, 30000);
// Initial check after delay (let IndexedDB initialize)
setTimeout(checkSyncStatus, 2000);
```

Add styles for the sync status indicator:

```css
.sync-status {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 6px;
  background: #1a3a1a;
  color: #aad;
  font-size: 0.75rem;
  z-index: 999;
}

.sync-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #ffb56b;
}
```

Note: This indicator is informational only in Phase 5. The actual sync happens in Phase 6. For now, ALL compositions have synced=false, so this always shows. That's intentional -- it reminds the user that cloud backup is coming.

Consider: You might want to hide this indicator entirely in Phase 5 (since sync doesn't exist yet) and only show it in Phase 6. If the team prefers this approach, wrap the sync check in a feature flag:

```typescript
const SHOW_SYNC_STATUS = false; // Enable in Phase 6
if (SHOW_SYNC_STATUS) {
  setInterval(checkSyncStatus, 30000);
  setTimeout(checkSyncStatus, 2000);
}
```
  </action>
  <verify>
1. Sync status indicator element exists in OfflineIndicator
2. Indicator shows count of unsynced compositions (or is feature-flagged off)
3. Indicator uses dynamic import for composition-store (lazy load)
4. Periodic check every 30 seconds
5. Does not break offline indicator functionality
6. Does not error when composition store not yet initialized
7. `cd portfolio && npm run build` succeeds
  </verify>
  <done>
Offline indicator extended with composition sync status for Phase 6 preparation. Shows "X compositions not synced" count via periodic check. Uses dynamic import for composition-store (lazy load). Feature-flagged for Phase 5 (disabled by default, enabled in Phase 6).
  </done>
</task>

<task type="auto">
  <name>Task 4: Bundle size audit and performance verification</name>
  <files>
    (no new files -- verification task)
  </files>
  <action>
Verify that the total mobile bundle is within the 1.2MB gzipped target and that performance meets the targets from 05-RESEARCH.md.

**Build and analyze:**

```bash
cd portfolio && npm run build
```

**Bundle size check:**

After build, check the total JS output size:
```bash
# Check total JS size in dist/
find portfolio/dist -name "*.js" -exec ls -la {} \; | awk '{total+=$5} END {print "Total JS (uncompressed):", total/1024/1024, "MB"}'
```

For gzipped estimate:
```bash
# Gzip individual files and check sizes
find portfolio/dist -name "*.js" -exec gzip -k {} \;
find portfolio/dist -name "*.js.gz" -exec ls -la {} \; | awk '{total+=$5} END {print "Total JS (gzipped):", total/1024/1024, "MB"}'
```

Target: < 1.2MB gzipped total.

If over budget, check:
1. React Flow tree-shaking: verify named imports in all files
2. React duplicate bundles: ensure only one React copy
3. Remove unused React Flow sub-packages (e.g., @reactflow/minimap if imported)

**Performance timing:**

In Chrome DevTools (or serve locally and use curl):

1. **Empty canvas load time:**
   - Navigate to /mobile/compose (new composition)
   - Measure time from navigation to canvas visible
   - Target: <2s on simulated 3G

2. **Add atom to canvas:**
   - Tap FAB, select atom
   - Measure time from tap to node visible
   - Target: <500ms cold, <200ms warm

3. **Routing UI response:**
   - Tap node on canvas
   - Measure time from tap to bottom sheet visible
   - Target: <200ms

4. **Composition list load:**
   - Navigate to /mobile/compositions with 5+ saved compositions
   - Measure time from navigation to list visible
   - Target: <300ms

**Memory check:**

Using Chrome DevTools Memory tab:
1. Load a composition with 5 atoms and 5 routes
2. Take heap snapshot
3. Target: <10MB heap for composition UI
4. If over: check for React Flow memory leaks, ensure React.memo is working

**If targets are missed:**

React Flow bundle too large (>200KB gzipped):
- Verify tree-shaking: `import { ReactFlow } from 'reactflow'` not `import ReactFlow from 'reactflow'`
- Remove any `import 'reactflow/dist/style.css'` and use only custom CSS
- Check if Background, Controls, MiniMap are imported but not used

Render time too slow (>500ms):
- Enable React Flow `onlyRenderVisibleElements` prop
- Reduce AtomNode complexity (fewer DOM elements per parameter)
- Consider React.lazy for node detail sheet
  </action>
  <verify>
1. Total JS bundle < 1.2MB gzipped
2. Empty canvas loads in < 2s on simulated 3G
3. Add atom to canvas < 500ms cold, < 200ms warm
4. Node detail sheet opens in < 200ms
5. Composition list renders in < 300ms for 10 items
6. Memory usage < 10MB for 5-atom composition
7. React Flow properly tree-shaken (check for unnecessary imports)
8. No duplicate React bundles in output
  </verify>
  <done>
Bundle size verified under 1.2MB gzipped target. Performance targets met: canvas load <2s, atom addition <500ms, routing UI <200ms. Memory under 10MB for 5-atom composition. React Flow tree-shaking confirmed via named imports.
  </done>
</task>

<task type="auto">
  <name>Task 5: End-to-end Phase 5 verification</name>
  <files>
    (no new files -- verification task)
  </files>
  <action>
Comprehensive verification of all Phase 5 requirements. This is the final check before declaring Phase 5 complete.

**Build, serve, and test:**
```bash
cd portfolio && npm run build && npm run preview
```

**COMP-01: User can add atoms to composition canvas**

1. Navigate to /mobile/compositions
2. Tap "New Composition"
3. On empty canvas, tap FAB "+"
4. Atom picker sheet slides up with atom list
5. Search for an atom by name - list filters
6. Tap an atom - node appears on canvas
7. Node shows atom name, type badge, and parameter handles with values
8. Repeat for 2nd, 3rd, 4th, 5th atom
9. At 5 atoms, FAB shows disabled state and picker shows limit message
10. Drag nodes to reposition them on canvas
11. Pinch-to-zoom works
12. Single-finger pan on background works

**COMP-02: User can route parameters (dropdown UI)**

1. With 2+ atoms on canvas, tap first atom node
2. Node detail sheet opens with parameter list
3. Parameters are color-coded by type (blue=number, green=string, orange=boolean)
4. Tap "+ Route" on a number parameter
5. Dropdown shows compatible number parameters from OTHER nodes
6. No self-routing shown, no object-type parameters shown
7. Tap a target - edge appears on canvas (blue, animated)
8. Toast: "Routed [source.param] -> [target].[param]"
9. Tap source node again - route visible under "Active Routes" with "OUT" label
10. Tap target node - same route visible with "IN" label
11. Delete route via X button - edge removed from canvas

**COMP-03: User can create rich combinations**

1. Create 3-5 atom composition
2. Create multiple routes between different atoms (A->B, B->C, A->C)
3. Routes can chain (A.param -> B.param -> C.param)
4. Many-to-one routing works (A.x -> C.z, B.y -> C.z)
5. One-to-many routing works (A.x -> B.y, A.x -> C.z)
6. All edges visible simultaneously on canvas

**MOB-05: User can access atoms offline**

1. Visit /mobile/gallery once while online (populates IndexedDB)
2. Visit /mobile/compositions, create a composition with 2 atoms and 1 route
3. Enable airplane mode (DevTools Network > Offline)
4. Reload /mobile/compositions - composition list loads from IndexedDB
5. Tap composition - canvas loads with nodes and edges from IndexedDB
6. Add another atom (from IndexedDB cache) - works offline
7. Create a route - works offline
8. Undo/redo - works offline
9. Navigate back to compositions list - shows updated composition
10. Disable airplane mode - return to normal

**Undo/Redo**

1. Add an atom -> tap undo -> atom removed
2. Tap redo -> atom reappears
3. Add 3 atoms, undo 3 times -> empty canvas
4. Redo 3 times -> all 3 atoms back
5. Add atom, undo, add different atom -> redo not available (branching)
6. Make 25 changes, undo all -> stops at 20 steps back (buffer limit)

**Composition Management**

1. Rename: tap composition name in toolbar -> prompt -> new name saved
2. Delete: tap delete button -> confirm -> navigates to compositions list
3. Composition list shows: name, atom count, route count, last modified
4. Most recent compositions at top

**Touch Optimization**

1. All buttons/tap targets >= 44px
2. No grey rectangles on iOS Safari (or simulated)
3. No scroll conflicts (canvas does not scroll the page)
4. No accidental zoom on double-tap
5. Pinch zoom smooth and responsive
6. Node drag smooth (no jitter)

**If any check fails:** Fix before declaring Phase 5 complete. Document the fix.
  </action>
  <verify>
COMP-01:
- [ ] Atoms addable to canvas via FAB + picker
- [ ] 5-atom limit enforced
- [ ] Nodes show name, type, parameters
- [ ] Drag, pan, zoom work on mobile

COMP-02:
- [ ] Dropdown routing UI with type-filtered targets
- [ ] Routes create edges on canvas
- [ ] Routes viewable and deletable in node detail
- [ ] Type matching enforced

COMP-03:
- [ ] Multi-route compositions work (A->B, B->C, A->C)
- [ ] Chaining, many-to-one, one-to-many all functional

MOB-05:
- [ ] Compositions persist in IndexedDB
- [ ] Canvas loads offline from IndexedDB
- [ ] Atom addition works offline (from cached atoms)
- [ ] Routing works offline
- [ ] Undo/redo works offline

PERSISTENCE:
- [ ] Composition auto-saves (debounced 500ms)
- [ ] Undo/redo works (20-state buffer)
- [ ] Rename and delete work
- [ ] Compositions list shows all saved compositions

PERFORMANCE:
- [ ] Bundle < 1.2MB gzipped
- [ ] Add atom < 500ms cold
- [ ] Routing UI < 200ms
- [ ] Memory < 10MB for 5 atoms

TOUCH:
- [ ] 48px touch targets on handles
- [ ] iOS grey rectangle fix
- [ ] No scroll conflicts
- [ ] Smooth gestures
  </verify>
  <done>
Phase 5 verified end-to-end. All requirements met: COMP-01 (add atoms to canvas), COMP-02 (route parameters via dropdown), COMP-03 (rich multi-atom combinations), MOB-05 (offline composition support). Touch optimized, performance within targets, persistence reliable. Ready for Phase 5 completion.
  </done>
</task>

</tasks>

<verification>
COMP-01: User can add atoms to composition canvas
- FAB button opens atom picker with searchable list
- Tapping atom adds node to canvas with name, type, and parameters
- 5-atom limit enforced with visual feedback
- Nodes draggable, canvas zoomable and pannable

COMP-02: User can route parameters (dropdown UI)
- Tap node opens detail sheet with typed parameter list
- "+ Route" shows compatible targets (same type, different node)
- Route creation adds edge to canvas
- Existing routes visible with delete option

COMP-03: User can create rich combinations
- Multiple routes supported (chaining, many-to-one, one-to-many)
- All edges visible simultaneously

MOB-05: User can access atoms offline
- Compositions persist in IndexedDB
- Full canvas workflow works offline after first visit
- Atom picker reads from IndexedDB cache offline

Performance:
- Bundle < 1.2MB gzipped
- Add atom < 500ms cold, < 200ms warm
- Routing UI < 200ms response
- Memory < 10MB for 5-atom composition

Touch:
- 48px touch targets on handles
- iOS grey rectangle prevention
- No scroll conflicts
- Smooth pan, zoom, drag gestures
</verification>

<success_criteria>
- All Phase 5 requirements verified: COMP-01, COMP-02, COMP-03, MOB-05
- Touch interaction meets Apple HIG standards (48px targets)
- iOS Safari rendering bugs prevented
- Bundle size within mobile performance budget
- Performance targets met on simulated mid-range device
- Full offline support for composition workflow
- Phase 5 ready for completion declaration
</success_criteria>

<output>
After completion, create `.planning/phases/05-composition-canvas-offline-support/05-05-SUMMARY.md`
Then create `.planning/phases/05-composition-canvas-offline-support/05-VERIFICATION.md`
</output>
