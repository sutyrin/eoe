---
phase: 01-foundation-visual-atoms-portfolio
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - cli/package.json
  - cli/index.js
  - cli/commands/create.js
  - cli/commands/dev.js
  - cli/templates/visual/sketch.js
  - cli/templates/visual/index.html
  - cli/templates/visual/config.json
  - cli/templates/visual/NOTES.md
autonomous: true

must_haves:
  truths:
    - "User can run `eoe create visual spiral` and get a date-prefixed atom folder with all files"
    - "User can run `eoe dev <atom>` and see the sketch running in browser with hot-reload"
    - "New sketch shows something alive immediately (not blank canvas)"
    - "lil-gui panel appears in dev mode with parameter controls"
    - "Editing sketch.js triggers hot-reload without duplicating canvases"
    - "config.json contains default parameters that the sketch reads on load"
  artifacts:
    - path: "cli/index.js"
      provides: "CLI entry point with commander.js program"
      contains: "#!/usr/bin/env node"
    - path: "cli/commands/create.js"
      provides: "eoe create command scaffolding atoms from templates"
      contains: "createCommand"
    - path: "cli/commands/dev.js"
      provides: "eoe dev command starting Vite for specific atom"
      contains: "devCommand"
    - path: "cli/templates/visual/sketch.js"
      provides: "Starter template with p5.js instance mode + lil-gui"
      contains: "new p5(sketch)"
    - path: "cli/templates/visual/index.html"
      provides: "Atom HTML entry point"
      contains: "type=\"module\""
    - path: "cli/templates/visual/config.json"
      provides: "Default parameter config"
      contains: "controllers"
    - path: "cli/templates/visual/NOTES.md"
      provides: "Creative log template"
      contains: "Session Log"
  key_links:
    - from: "cli/index.js"
      to: "cli/commands/create.js"
      via: "commander addCommand"
      pattern: "addCommand.*createCommand"
    - from: "cli/index.js"
      to: "cli/commands/dev.js"
      via: "commander addCommand"
      pattern: "addCommand.*devCommand"
    - from: "cli/commands/create.js"
      to: "cli/templates/visual/"
      via: "fs-extra copy"
      pattern: "fs\\.copy|fs-extra.*copy"
    - from: "cli/templates/visual/sketch.js"
      to: "config.json"
      via: "fetch('./config.json')"
      pattern: "fetch.*config\\.json"
    - from: "cli/templates/visual/sketch.js"
      to: "lil-gui"
      via: "import GUI from 'lil-gui'"
      pattern: "import.*lil-gui"
---

<objective>
Create the CLI tool (`eoe`) with `create` and `dev` commands, plus the visual atom template with p5.js instance mode, lil-gui parameter panel, and HMR cleanup. After this plan, users can scaffold and develop visual atoms in short bursts.

Purpose: This is the core creative workflow -- scaffold a sketch and start coding. Without this, no atoms can be created. This covers 6 requirements (CLI-01/02, VIS-01/02/03/04).
Output: Working `eoe create visual <name>` and `eoe dev <atom>` commands, plus a starter template that shows something alive immediately.
</objective>

<execution_context>
@/home/pavel/.claude/get-shit-done/workflows/execute-plan.md
@/home/pavel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-visual-atoms-portfolio/01-RESEARCH.md
@.planning/phases/01-foundation-visual-atoms-portfolio/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI framework, atom template files, and create command</name>
  <files>
    cli/package.json
    cli/index.js
    cli/commands/create.js
    cli/templates/visual/sketch.js
    cli/templates/visual/index.html
    cli/templates/visual/config.json
    cli/templates/visual/NOTES.md
  </files>
  <action>
Create the CLI package and the `eoe create` command with full visual atom template.

**cli/package.json:**
```json
{
  "name": "eoe-cli",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "bin": {
    "eoe": "./index.js"
  },
  "dependencies": {
    "commander": "^14.0.2",
    "fs-extra": "^11.0.0",
    "chalk": "^5.0.0"
  }
}
```

**cli/index.js** -- CLI entry point:
```javascript
#!/usr/bin/env node
import { program } from 'commander';
import { createCommand } from './commands/create.js';
import { devCommand } from './commands/dev.js';

program
  .name('eoe')
  .description('Engines of Experience - Creative atom toolkit')
  .version('1.0.0');

program.addCommand(createCommand);
program.addCommand(devCommand);

program.parse();
```

**cli/commands/create.js** -- Scaffold new atoms:
Follow the research pattern. Key behaviors:
- `eoe create visual <name>` creates `atoms/YYYY-MM-DD-<name>/`
- Copies template files from `cli/templates/visual/`
- Replaces `{{ATOM_NAME}}` placeholders in all template files with the atom name
- Replaces `{{DATE}}` with current date (YYYY-MM-DD)
- Replaces `{{TIME}}` with current time (HH:MM)
- Only `visual` type supported in Phase 1 (error on other types)
- Error if atom folder already exists
- Prints success message with next command hint

Implementation:
```javascript
import { Command } from 'commander';
import fs from 'fs-extra';
import path from 'path';
import chalk from 'chalk';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

export const createCommand = new Command('create')
  .argument('<type>', 'Atom type (visual)')
  .argument('<name>', 'Atom name (lowercase, no spaces)')
  .description('Scaffold a new atom from template')
  .action(async (type, name) => {
    if (type !== 'visual') {
      console.error(chalk.red(`Type "${type}" not supported yet. Available: visual`));
      process.exit(1);
    }

    const date = new Date().toISOString().split('T')[0];
    const time = new Date().toTimeString().split(' ')[0].slice(0, 5);
    const atomName = `${date}-${name}`;
    const atomPath = path.resolve('atoms', atomName);

    if (await fs.pathExists(atomPath)) {
      console.error(chalk.red(`Atom "${atomName}" already exists`));
      process.exit(1);
    }

    const templatePath = path.join(__dirname, '../templates/visual');
    await fs.copy(templatePath, atomPath);

    // Replace placeholders in all files
    const files = await fs.readdir(atomPath);
    for (const file of files) {
      const filePath = path.join(atomPath, file);
      const stat = await fs.stat(filePath);
      if (stat.isFile()) {
        let content = await fs.readFile(filePath, 'utf8');
        content = content.replaceAll('{{ATOM_NAME}}', name);
        content = content.replaceAll('{{FULL_ATOM_NAME}}', atomName);
        content = content.replaceAll('{{DATE}}', date);
        content = content.replaceAll('{{TIME}}', time);
        await fs.writeFile(filePath, content);
      }
    }

    console.log(chalk.green(`Created atom: ${atomName}`));
    console.log(chalk.gray(`  cd atoms/${atomName}`));
    console.log(chalk.gray(`  eoe dev ${atomName}`));
  });
```

**cli/templates/visual/sketch.js** -- Starter template (LOCKED: instance mode, plain JS, 800x800, lil-gui, alive immediately):
Use the research starter template with HMR cleanup pattern. The sketch must show something moving and colorful on first load:

```javascript
import p5 from 'p5';
import GUI from 'lil-gui';

let p5Instance;

const sketch = (p) => {
  let config = {
    bgHue: 200,
    shapeHue: 30,
    size: 100,
    speed: 1,
    noiseScale: 0.01
  };

  let time = 0;
  let gui;

  p.setup = () => {
    p.createCanvas(800, 800);
    p.colorMode(p.HSB, 360, 100, 100);
    p.noStroke();
    loadConfig();
  };

  p.draw = () => {
    p.background(config.bgHue, 30, 95);
    const x = p.width / 2 + p.noise(time) * 50 - 25;
    const y = p.height / 2 + p.noise(time + 100) * 50 - 25;
    const size = config.size + p.sin(time * config.speed) * 20;
    p.fill(config.shapeHue, 80, 90);
    p.circle(x, y, size);
    time += config.noiseScale;
  };

  async function loadConfig() {
    try {
      const response = await fetch('./config.json');
      const saved = await response.json();
      Object.assign(config, saved.controllers || saved);
    } catch (e) {
      console.log('No saved config, using defaults');
    }
    setupGUI();
  }

  function setupGUI() {
    gui = new GUI({ title: '{{ATOM_NAME}} Parameters' });
    gui.add(config, 'bgHue', 0, 360).name('Background Hue');
    gui.add(config, 'shapeHue', 0, 360).name('Shape Hue');
    gui.add(config, 'size', 50, 200).name('Size');
    gui.add(config, 'speed', 0.1, 5).name('Speed');
    gui.add(config, 'noiseScale', 0.001, 0.1).name('Noise Scale');

    gui.onChange(() => {
      console.log('Copy to config.json:', JSON.stringify({ controllers: config }, null, 2));
    });
  }
};

p5Instance = new p5(sketch);

// Vite HMR cleanup (prevents canvas duplication)
if (import.meta.hot) {
  import.meta.hot.dispose(() => {
    if (p5Instance) {
      p5Instance.remove();
      p5Instance = null;
    }
  });
}
```

**cli/templates/visual/index.html:**
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ATOM_NAME}}</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #0a0a0a;
    }
  </style>
</head>
<body>
  <script type="module" src="./sketch.js"></script>
</body>
</html>
```

Note: Use `src="./sketch.js"` (relative path), NOT `src="/atoms/{{ATOM_NAME}}/sketch.js"` (absolute path). Relative path works whether served by Vite from root or opened directly. The atom folder is self-contained.

**cli/templates/visual/config.json:**
```json
{
  "controllers": {
    "bgHue": 200,
    "shapeHue": 30,
    "size": 100,
    "speed": 1,
    "noiseScale": 0.01
  }
}
```

**cli/templates/visual/NOTES.md:**
```markdown
# {{ATOM_NAME}}

**Created:** {{DATE}}
**Stage:** idea

## Intent
What am I exploring with this atom? What feeling or concept?

## Technical Decisions
- Why this approach?
- What techniques/algorithms?

## Session Log

### {{DATE}} {{TIME}}
- Created atom
- Initial setup
```

After creating all files, run `npm install` from project root to install CLI dependencies, then run `npm link ./cli` (or add cli to PATH) so `eoe` command is available globally.

IMPORTANT: The `bin` field in cli/package.json makes `eoe` available. Run `npm install` at root (workspaces auto-install cli deps). Then either:
- `npx eoe` from project root, OR
- `npm link ./cli` to make `eoe` available globally

Prefer `npm link ./cli` for the natural `eoe create visual spiral` workflow.

Make cli/index.js executable: `chmod +x cli/index.js`
  </action>
  <verify>
Run `chmod +x cli/index.js && npm install && npm link ./cli`. Then test:
1. `eoe --help` shows program description with create and dev commands
2. `eoe create visual test-atom` creates `atoms/YYYY-MM-DD-test-atom/` with sketch.js, index.html, config.json, NOTES.md
3. Verify template replacements: `grep "test-atom" atoms/*/sketch.js` finds the atom name in GUI title
4. Verify no `{{ATOM_NAME}}` placeholders remain: `grep -r "{{" atoms/*/`
5. `eoe create visual test-atom` (again) shows error "already exists"
6. `eoe create audio something` shows error "not supported"
  </verify>
  <done>
`eoe create visual <name>` scaffolds a date-prefixed atom folder with sketch.js (p5.js instance mode, lil-gui, HMR cleanup, alive-immediately pattern), index.html, config.json, and NOTES.md. All template placeholders replaced. CLI framework supports adding more commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dev command and verify full create-to-dev workflow</name>
  <files>
    cli/commands/dev.js
  </files>
  <action>
Create the `eoe dev <atom>` command that starts Vite targeting a specific atom and auto-logs a session entry.

**cli/commands/dev.js:**
```javascript
import { Command } from 'commander';
import { spawn } from 'child_process';
import path from 'path';
import fs from 'fs-extra';
import chalk from 'chalk';

export const devCommand = new Command('dev')
  .argument('<atom>', 'Atom name to develop (e.g., 2026-01-29-spiral)')
  .description('Start Vite dev server for an atom with hot-reload')
  .action(async (atomName) => {
    const atomPath = path.resolve('atoms', atomName);

    if (!await fs.pathExists(atomPath)) {
      console.error(chalk.red(`Atom "${atomName}" not found in atoms/`));
      console.error(chalk.gray('Run `eoe create visual <name>` to create one'));
      process.exit(1);
    }

    // Append session log entry to NOTES.md
    const notesPath = path.join(atomPath, 'NOTES.md');
    if (await fs.pathExists(notesPath)) {
      const timestamp = new Date().toISOString().replace('T', ' ').split('.')[0];
      const sessionEntry = `\n### ${timestamp}\n- \n`;
      await fs.appendFile(notesPath, sessionEntry);
      console.log(chalk.gray('Session logged to NOTES.md'));
    }

    console.log(chalk.blue(`Starting dev server for ${atomName}...`));
    console.log(chalk.gray(`Opening: http://localhost:5173/atoms/${atomName}/index.html`));

    // Start Vite with open flag pointing to the atom
    const vite = spawn('npx', ['vite', '--open', `/atoms/${atomName}/index.html`], {
      stdio: 'inherit',
      cwd: process.cwd()
    });

    vite.on('close', (code) => {
      if (code !== 0 && code !== null) {
        console.error(chalk.red(`Vite exited with code ${code}`));
      }
    });
  });
```

Key behaviors:
- Validates atom exists before starting
- Appends timestamped session entry to NOTES.md (auto-tracking per CONTEXT.md decision)
- Starts Vite from project root (not atom dir) so all atoms are accessible
- Opens browser to the specific atom's index.html
- Passes stdio through so Vite output is visible

After creating dev.js, verify the full workflow:
1. Create a test atom: `eoe create visual hello`
2. Start dev server: `eoe dev <full-atom-name>`
3. Verify browser opens with animated sketch (something alive, not blank)
4. Edit sketch.js slightly (change a color value) and verify hot-reload works without canvas duplication
5. Verify lil-gui panel appears with parameter sliders
6. Clean up: stop dev server, optionally remove test atom
  </action>
  <verify>
1. `eoe dev nonexistent` shows error message with helpful hint
2. Create test atom and run `eoe dev <atom-name>` -- Vite starts and opens browser
3. Check NOTES.md has a new session entry with timestamp
4. In browser: sketch shows animated shape (alive immediately), lil-gui panel visible with 5 parameters
5. Edit sketch.js (change bgHue default to 100), save -- browser updates without page reload, single canvas remains
6. Stop Vite (Ctrl+C), confirm clean exit
  </verify>
  <done>
`eoe dev <atom>` starts Vite dev server with hot-reload targeting the specified atom, auto-logs session to NOTES.md, and opens browser. Full create-to-dev workflow works: scaffold atom, start dev, see live sketch with lil-gui panel, edit code with hot-reload, session auto-tracked.
  </done>
</task>

</tasks>

<verification>
1. Full workflow test: `eoe create visual mysketch` then `eoe dev YYYY-MM-DD-mysketch`
2. Browser shows animated p5.js sketch with lil-gui parameter panel
3. Hot-reload works: edit sketch.js, changes appear without page refresh
4. No canvas duplication: HMR cleanup removes old instance before creating new one
5. config.json values loaded by sketch on startup
6. NOTES.md has initial creation entry + session log entry from dev command
7. Error handling: invalid atom name, missing atom, duplicate create all produce helpful messages
</verification>

<success_criteria>
- `eoe create visual <name>` scaffolds complete atom in <2 seconds
- `eoe dev <atom>` starts Vite and opens browser to running sketch in <5 seconds
- Sketch shows animated visuals immediately (not blank canvas) -- LOCKED DECISION
- lil-gui panel with 5 parameters visible in browser
- Hot-reload preserves single canvas (no duplication)
- config.json is source of truth for parameters
- NOTES.md auto-tracks session timestamps
- p5.js uses instance mode throughout (p.createCanvas, p.draw, etc.) -- LOCKED DECISION
- Plain JavaScript, no TypeScript -- LOCKED DECISION
- Canvas size 800x800 -- LOCKED DECISION
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-visual-atoms-portfolio/01-02-SUMMARY.md`
</output>
