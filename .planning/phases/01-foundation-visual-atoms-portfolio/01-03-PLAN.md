---
phase: 01-foundation-visual-atoms-portfolio
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - portfolio/package.json
  - portfolio/astro.config.mjs
  - portfolio/src/pages/index.astro
  - portfolio/src/pages/atom/[slug].astro
  - portfolio/src/components/P5Sketch.astro
  - portfolio/src/layouts/Base.astro
  - portfolio/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Portfolio site builds with `npm run build` in portfolio/ workspace"
    - "Portfolio index page lists all atoms from atoms/ directory"
    - "Each atom has a dedicated page with embedded running sketch"
    - "Sketches are playable (interactive p5.js canvas) in portfolio pages"
  artifacts:
    - path: "portfolio/package.json"
      provides: "Astro project with dependencies"
      contains: "astro"
    - path: "portfolio/astro.config.mjs"
      provides: "Astro configuration"
      contains: "defineConfig"
    - path: "portfolio/src/pages/index.astro"
      provides: "Portfolio home page with atom grid"
      contains: "atoms"
    - path: "portfolio/src/pages/atom/[slug].astro"
      provides: "Individual atom detail page"
      contains: "getStaticPaths"
    - path: "portfolio/src/components/P5Sketch.astro"
      provides: "Reusable p5.js sketch embedding component"
      contains: "p5-container"
    - path: "portfolio/src/layouts/Base.astro"
      provides: "Shared page layout"
      contains: "html"
  key_links:
    - from: "portfolio/src/pages/index.astro"
      to: "atoms/"
      via: "fs.readdirSync to discover atom folders"
      pattern: "readdirSync.*atoms"
    - from: "portfolio/src/components/P5Sketch.astro"
      to: "p5.js"
      via: "dynamic import of p5 library"
      pattern: "import.*p5"
    - from: "portfolio/src/pages/atom/[slug].astro"
      to: "portfolio/src/components/P5Sketch.astro"
      via: "component import"
      pattern: "P5Sketch"
---

<objective>
Set up the Astro portfolio site that displays all creative atoms as a browsable gallery with embedded playable sketches. Users can view their body of work in a public-ready static site.

Purpose: The portfolio is how atoms become visible as a body of work. Without it, sketches only exist as individual dev server pages. This covers Success Criteria #3 ("view all created atoms in a web portfolio with embedded playable contraptions").
Output: A working Astro site with index grid and per-atom detail pages, each embedding the live p5.js sketch.
</objective>

<execution_context>
@/home/pavel/.claude/get-shit-done/workflows/execute-plan.md
@/home/pavel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-visual-atoms-portfolio/01-RESEARCH.md
@.planning/phases/01-foundation-visual-atoms-portfolio/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Astro portfolio project with base layout and P5Sketch component</name>
  <files>
    portfolio/package.json
    portfolio/astro.config.mjs
    portfolio/tsconfig.json
    portfolio/src/layouts/Base.astro
    portfolio/src/components/P5Sketch.astro
  </files>
  <action>
Create the Astro portfolio workspace. Use Astro 5.16.x (stable, LOCKED from research -- not Astro 6 beta).

**portfolio/package.json:**
```json
{
  "name": "eoe-portfolio",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "astro dev",
    "build": "astro build",
    "preview": "astro preview"
  },
  "dependencies": {
    "astro": "^5.16.11"
  }
}
```

Note: p5.js and lil-gui come from root workspace -- do NOT duplicate them in portfolio/package.json.

**portfolio/tsconfig.json:**
```json
{
  "extends": "astro/tsconfigs/strict"
}
```

**portfolio/astro.config.mjs:**
```javascript
import { defineConfig } from 'astro/config';

export default defineConfig({
  // Atoms are loaded at build time from ../atoms/
  // Each atom's sketch.js is copied to public/ during build
  vite: {
    // Allow importing from parent directory (atoms/)
    server: {
      fs: {
        allow: ['..']
      }
    }
  }
});
```

**portfolio/src/layouts/Base.astro:**
A minimal layout for all pages. Dark theme to match creative coding aesthetic (dark canvas backgrounds).

```astro
---
export interface Props {
  title: string;
}
const { title } = Astro.props;
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title} - Engines of Experience</title>
  <style is:global>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    a { color: #6bb5ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header style="padding: 2rem; border-bottom: 1px solid #222;">
    <a href="/" style="font-size: 1.2rem; font-weight: bold; color: #fff;">
      Engines of Experience
    </a>
  </header>
  <main style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
    <slot />
  </main>
</body>
</html>
```

**portfolio/src/components/P5Sketch.astro:**
A component that embeds a p5.js sketch on the page. Uses client-side JavaScript to load the sketch in instance mode. Since atom sketches use relative imports (`import p5 from 'p5'`), we need to adapt them for the portfolio context.

The approach: Copy each atom's sketch.js into the portfolio's public/ directory at build time, and load it via a script tag. The sketch already creates its own canvas via `new p5(sketch)`.

However, for Astro SSG, the simplest working approach is to use an iframe pointing to the atom's own index.html served from a known path:

```astro
---
export interface Props {
  atomName: string;
  width?: number;
  height?: number;
}

const { atomName, width = 800, height = 800 } = Astro.props;
---

<div class="p5-container">
  <iframe
    src={`/atoms/${atomName}/index.html`}
    width={width}
    height={height}
    style="border: none; border-radius: 4px;"
    loading="lazy"
    title={atomName}
  ></iframe>
</div>

<style>
  .p5-container {
    display: flex;
    justify-content: center;
    margin: 1rem 0;
  }
  iframe {
    max-width: 100%;
  }
</style>
```

The iframe approach is the most reliable for Phase 1 because:
- Each atom is already a self-contained folder with index.html + sketch.js
- No need to rewrite import paths or bundle differently
- The lil-gui panel stays contained within the iframe (portfolio visitors don't see it -- we can control this with a query param later)
- Each atom folder just needs to be copied to portfolio's `public/atoms/` directory

Add a build script or Astro integration that copies atoms/ to portfolio/public/atoms/ before build. For simplicity, use a pre-build script.

Update portfolio/package.json scripts:
```json
"scripts": {
  "dev": "node scripts/copy-atoms.js && astro dev",
  "build": "node scripts/copy-atoms.js && astro build",
  "preview": "astro preview"
}
```

Create **portfolio/scripts/copy-atoms.js:**
```javascript
import fs from 'fs-extra';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const atomsSrc = path.resolve(__dirname, '../../atoms');
const atomsDest = path.resolve(__dirname, '../public/atoms');

// Clean and copy
await fs.remove(atomsDest);
if (await fs.pathExists(atomsSrc)) {
  await fs.copy(atomsSrc, atomsDest);
  const atoms = (await fs.readdir(atomsSrc, { withFileTypes: true }))
    .filter(d => d.isDirectory())
    .map(d => d.name);
  console.log(`Copied ${atoms.length} atoms to portfolio/public/atoms/`);
} else {
  await fs.ensureDir(atomsDest);
  console.log('No atoms found, created empty atoms directory');
}
```

Add fs-extra as portfolio dependency:
```json
"dependencies": {
  "astro": "^5.16.11",
  "fs-extra": "^11.0.0"
}
```
  </action>
  <verify>
Run `npm install` from project root. Verify `portfolio/node_modules/astro` exists. Run `node portfolio/scripts/copy-atoms.js` and confirm it runs without error (may copy 0 atoms if none exist yet). Check that all files exist: portfolio/package.json, astro.config.mjs, tsconfig.json, src/layouts/Base.astro, src/components/P5Sketch.astro.
  </verify>
  <done>
Astro portfolio project scaffolded with Base layout, P5Sketch component (iframe-based embedding), and atom-copying build script. Dependencies installed. Ready for page creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create portfolio pages (index grid and atom detail pages)</name>
  <files>
    portfolio/src/pages/index.astro
    portfolio/src/pages/atom/[slug].astro
  </files>
  <action>
Create the two main pages: the home page (grid of all atoms) and the detail page (single atom with embedded sketch).

**portfolio/src/pages/index.astro:**
```astro
---
import Base from '../layouts/Base.astro';
import fs from 'node:fs';
import path from 'node:path';

// Read atoms from the copied public/atoms directory
const atomsDir = path.resolve('./public/atoms');
let atoms = [];

if (fs.existsSync(atomsDir)) {
  atoms = fs.readdirSync(atomsDir, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => {
      const configPath = path.join(atomsDir, d.name, 'config.json');
      const notesPath = path.join(atomsDir, d.name, 'NOTES.md');
      let stage = 'idea';

      // Try to read stage from NOTES.md
      if (fs.existsSync(notesPath)) {
        const notes = fs.readFileSync(notesPath, 'utf8');
        const stageMatch = notes.match(/\*\*Stage:\*\*\s*(\w+)/);
        if (stageMatch) stage = stageMatch[1];
      }

      // Extract name and date from folder name (YYYY-MM-DD-name)
      const parts = d.name.match(/^(\d{4}-\d{2}-\d{2})-(.+)$/);
      const date = parts ? parts[1] : '';
      const name = parts ? parts[2] : d.name;

      return { slug: d.name, name, date, stage };
    })
    .sort((a, b) => b.date.localeCompare(a.date)); // Newest first
}
---

<Base title="Gallery">
  <h1 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Gallery</h1>

  {atoms.length === 0 && (
    <p style="color: #666;">
      No atoms yet. Run <code style="color: #6bb5ff;">eoe create visual &lt;name&gt;</code> to get started.
    </p>
  )}

  <div class="atom-grid">
    {atoms.map(atom => (
      <a href={`/atom/${atom.slug}`} class="atom-card">
        <div class="atom-preview">
          <iframe
            src={`/atoms/${atom.slug}/index.html`}
            width="400"
            height="400"
            style="border: none; pointer-events: none; transform: scale(0.5); transform-origin: top left;"
            loading="lazy"
            title={atom.name}
          ></iframe>
        </div>
        <div class="atom-info">
          <span class="atom-name">{atom.name}</span>
          <span class="atom-meta">{atom.date} &middot; {atom.stage}</span>
        </div>
      </a>
    ))}
  </div>

  <style>
    .atom-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.5rem;
    }
    .atom-card {
      background: #151515;
      border: 1px solid #222;
      border-radius: 8px;
      overflow: hidden;
      text-decoration: none;
      transition: border-color 0.2s;
    }
    .atom-card:hover {
      border-color: #444;
      text-decoration: none;
    }
    .atom-preview {
      width: 100%;
      height: 200px;
      overflow: hidden;
      background: #0a0a0a;
    }
    .atom-info {
      padding: 0.75rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .atom-name {
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
    }
    .atom-meta {
      color: #666;
      font-size: 0.8rem;
    }
  </style>
</Base>
```

**portfolio/src/pages/atom/[slug].astro:**
```astro
---
import Base from '../../layouts/Base.astro';
import P5Sketch from '../../components/P5Sketch.astro';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const atomsDir = path.resolve('./public/atoms');
  if (!fs.existsSync(atomsDir)) return [];

  const atoms = fs.readdirSync(atomsDir, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => d.name);

  return atoms.map(slug => ({
    params: { slug },
    props: { slug }
  }));
}

const { slug } = Astro.params;

// Parse atom metadata
const parts = slug.match(/^(\d{4}-\d{2}-\d{2})-(.+)$/);
const date = parts ? parts[1] : '';
const name = parts ? parts[2] : slug;

// Read NOTES.md if exists
const notesPath = path.resolve(`./public/atoms/${slug}/NOTES.md`);
let notes = '';
let stage = 'idea';
if (fs.existsSync(notesPath)) {
  notes = fs.readFileSync(notesPath, 'utf8');
  const stageMatch = notes.match(/\*\*Stage:\*\*\s*(\w+)/);
  if (stageMatch) stage = stageMatch[1];
}
---

<Base title={name}>
  <div style="margin-bottom: 1rem;">
    <a href="/" style="color: #666; font-size: 0.85rem;">&larr; Back to Gallery</a>
  </div>

  <h1 style="margin-bottom: 0.5rem; font-size: 1.5rem;">{name}</h1>
  <p style="color: #666; margin-bottom: 2rem; font-size: 0.85rem;">
    {date} &middot; {stage}
  </p>

  <P5Sketch atomName={slug} />

  {notes && (
    <details style="margin-top: 2rem;">
      <summary style="cursor: pointer; color: #888;">Notes</summary>
      <pre style="margin-top: 1rem; padding: 1rem; background: #151515; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap;">{notes}</pre>
    </details>
  )}
</Base>
```

After creating both pages, run the portfolio dev server to verify:
```bash
cd portfolio && npm run dev
```

If no atoms exist yet, the index page should show the empty state message. If test atoms were created during Plan 02, they should appear in the grid.
  </action>
  <verify>
1. Run `npm run dev --workspace=portfolio` (or `cd portfolio && npm run dev`)
2. Index page loads at localhost:4321 with "Gallery" heading
3. If atoms exist: grid shows atom cards with preview iframes, clicking a card navigates to /atom/[slug]
4. If no atoms: empty state message shown
5. Detail page shows atom name, date, stage, embedded running sketch, and collapsible notes
6. Run `npm run build --workspace=portfolio` -- Astro static build completes without errors
  </verify>
  <done>
Portfolio site has working index page (grid of all atoms sorted by date) and detail pages (embedded live sketch with notes). Both pages read from atoms/ directory. Empty state handled gracefully. Static build works for deployment.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=portfolio` produces a static site in portfolio/dist/
2. Portfolio index page discovers and displays all atom folders from atoms/
3. Each atom card links to a detail page with embedded running sketch
4. Sketches are interactive (p5.js canvas responds to user input if applicable)
5. Empty state shows helpful message when no atoms exist
6. Dark theme throughout (matches creative coding aesthetic)
7. Atom metadata (name, date, stage) displayed correctly from folder name and NOTES.md
</verification>

<success_criteria>
- Portfolio builds as static site with Astro 5.x
- Index page shows grid of all atoms with thumbnails (iframe previews)
- Detail page embeds live playable sketch (not just a screenshot)
- Atoms discovered dynamically from atoms/ directory (no hardcoded list)
- Page layout is dark-themed, monospace font, creative coding aesthetic
- Back navigation between detail and index pages works
- NOTES.md content viewable on detail page
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-visual-atoms-portfolio/01-03-SUMMARY.md`
</output>
