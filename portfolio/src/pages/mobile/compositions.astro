---
import MobileLayout from '../../layouts/MobileLayout.astro';
---

<MobileLayout title="Compositions">
  <!-- Draft Compositions Section -->
  <div class="comp-section">
    <div class="comp-section-title">Drafts</div>
    <div id="draft-list" class="comp-list">
      <!-- Populated from IndexedDB on client side -->
    </div>
    <div id="draft-empty" class="comp-empty-inline" style="display: none;">
      No draft compositions yet.
    </div>
  </div>

  <!-- Snapshots Section -->
  <div class="comp-section" id="snapshot-section" style="display: none;">
    <div class="comp-section-title">Snapshots</div>
    <div id="snapshot-list" class="comp-list">
      <!-- Populated from IndexedDB on client side -->
    </div>
  </div>

  <a href="/mobile/compose" class="btn btn-primary" id="new-comp-btn" style="width: 100%; margin-top: 16px;">
    + New Composition
  </a>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <a href="/mobile/gallery" class="bottom-nav-item">Gallery</a>
    <a href="/mobile/compositions" class="bottom-nav-item active">Compose</a>
  </nav>
</MobileLayout>

<script>
  import { getAllCompositions, deleteComposition } from '../../scripts/composition-store';
  import {
    getAllSnapshots,
    deleteSnapshot,
    formatSnapshotSize,
    getSnapshotSize,
  } from '../../scripts/composition-snapshot';

  async function loadCompositions() {
    const draftListEl = document.getElementById('draft-list')!;
    const draftEmptyEl = document.getElementById('draft-empty')!;
    const snapshotListEl = document.getElementById('snapshot-list')!;
    const snapshotSectionEl = document.getElementById('snapshot-section')!;

    // Load drafts
    const compositions = await getAllCompositions();

    if (compositions.length === 0) {
      draftListEl.innerHTML = '';
      draftEmptyEl.style.display = 'block';
    } else {
      draftEmptyEl.style.display = 'none';

      draftListEl.innerHTML = compositions.map(comp => {
        const atomCount = comp.atoms.length;
        const routeCount = comp.routes.length;
        const date = new Date(comp.updatedAt).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        return `
          <a href="/mobile/compose?id=${comp.id}" class="comp-item">
            <div class="comp-item-info">
              <span class="comp-item-name">${comp.name}</span>
              <span class="comp-item-meta">
                ${atomCount} atom${atomCount !== 1 ? 's' : ''} &middot;
                ${routeCount} route${routeCount !== 1 ? 's' : ''} &middot;
                ${date}
              </span>
            </div>
            <button class="comp-item-delete" data-id="${comp.id}" data-type="draft" title="Delete">&times;</button>
          </a>
        `;
      }).join('');
    }

    // Load snapshots
    const snapshots = await getAllSnapshots();

    if (snapshots.length === 0) {
      snapshotSectionEl.style.display = 'none';
    } else {
      snapshotSectionEl.style.display = 'block';

      snapshotListEl.innerHTML = snapshots.map(snapshot => {
        const atomCount = snapshot.atoms.length;
        const routeCount = snapshot.routes.length;
        const date = new Date(snapshot.createdAt).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        const size = formatSnapshotSize(getSnapshotSize(snapshot));

        return `
          <div class="comp-item-wrapper">
            <a href="/mobile/compose?snapshot=${snapshot.id}" class="comp-item">
              <div class="comp-item-info">
                <span class="comp-item-name">
                  ${snapshot.name}
                  <span class="snapshot-badge">Snapshot</span>
                </span>
                <span class="comp-item-meta">
                  ${atomCount} atom${atomCount !== 1 ? 's' : ''} &middot;
                  ${routeCount} route${routeCount !== 1 ? 's' : ''} &middot;
                  ${size} &middot;
                  ${date}
                </span>
              </div>
              <button class="comp-item-delete" data-id="${snapshot.id}" data-type="snapshot" title="Delete">&times;</button>
            </a>
            <div class="snapshot-actions">
              <a href="/mobile/compose?snapshot=${snapshot.id}" class="snapshot-open-btn">Open</a>
              <button class="snapshot-share-btn" data-snapshot-id="${snapshot.id}">Share</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Delete handlers
    document.querySelectorAll('.comp-item-delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const id = (btn as HTMLElement).dataset.id;
        const type = (btn as HTMLElement).dataset.type;
        if (id && confirm(`Delete this ${type}?`)) {
          if (type === 'snapshot') {
            await deleteSnapshot(id);
          } else {
            await deleteComposition(id);
          }
          loadCompositions(); // Refresh list
        }
      });
    });

    // Share snapshot handlers
    document.querySelectorAll('.snapshot-share-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const el = e.target as HTMLButtonElement;
        const snapId = el.getAttribute('data-snapshot-id');
        if (!snapId) return;

        el.textContent = 'Uploading...';
        el.disabled = true;

        try {
          const { shareSnapshot } = await import('../../scripts/composition-snapshot');
          const url = await shareSnapshot(snapId);

          if (url) {
            await navigator.clipboard.writeText(window.location.origin + url);
            el.textContent = 'Link copied!';
          } else {
            el.textContent = 'Share failed';
          }
        } catch {
          el.textContent = 'Share failed';
        }

        setTimeout(() => {
          el.textContent = 'Share';
          el.disabled = false;
        }, 2000);
      });
    });
  }

  loadCompositions();
</script>

<style>
  .comp-section {
    margin-bottom: 24px;
  }

  .comp-section-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #666;
    margin-bottom: 8px;
    padding: 0 4px;
  }

  .comp-list {
    margin-bottom: 8px;
  }

  .comp-empty-inline {
    padding: 24px 16px;
    text-align: center;
    color: #555;
    font-size: 0.85rem;
  }

  .comp-item-wrapper {
    border-bottom: 1px solid #1a1a1a;
  }

  .comp-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px 8px;
    text-decoration: none;
    color: inherit;
    min-height: 64px;
  }

  .comp-item:active {
    background: #1a1a1a;
  }

  .comp-item-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }

  .comp-item-name {
    color: #fff;
    font-weight: 600;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .snapshot-badge {
    display: inline-block;
    padding: 2px 6px;
    background: #6bb5ff20;
    color: #6bb5ff;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .comp-item-meta {
    color: #666;
    font-size: 0.8rem;
  }

  .comp-item-delete {
    width: 36px;
    height: 36px;
    border: none;
    background: #1a1a1a;
    color: #888;
    border-radius: 18px;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .comp-item-delete:active {
    background: #ff444440;
    color: #ff4444;
  }

  .comp-empty {
    text-align: center;
    padding: 48px 24px;
  }

  .comp-empty-title {
    color: #888;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .comp-empty-text {
    color: #555;
    font-size: 0.85rem;
  }

  .btn {
    padding: 14px 20px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .btn-primary {
    background: #6bb5ff;
    color: #0a0a0a;
  }

  .btn-primary:active {
    opacity: 0.9;
  }

  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    background: #111;
    border-top: 1px solid #222;
    padding-bottom: env(safe-area-inset-bottom, 0);
    z-index: 100;
  }

  .bottom-nav-item {
    flex: 1;
    padding: 12px;
    text-align: center;
    color: #666;
    font-size: 0.85rem;
    font-weight: 600;
    text-decoration: none;
    min-height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bottom-nav-item.active {
    color: #6bb5ff;
  }

  .bottom-nav-item:active {
    background: #1a1a1a;
  }

  .snapshot-actions {
    display: flex;
    gap: 8px;
    padding: 0 16px 10px;
  }

  .snapshot-open-btn, .snapshot-share-btn {
    padding: 6px 14px;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    min-height: 32px;
    -webkit-tap-highlight-color: transparent;
  }

  .snapshot-open-btn {
    background: #333;
    color: #6bb5ff;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
  }

  .snapshot-open-btn:active {
    background: #404040;
  }

  .snapshot-share-btn {
    background: #222;
    color: #ccc;
    border: 1px solid #333;
  }

  .snapshot-share-btn:active {
    background: #2a2a2a;
  }

  .snapshot-share-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
