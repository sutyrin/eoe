---
import MobileLayout from '../../layouts/MobileLayout.astro';
import CompositionCanvas from '../../components/CompositionCanvas.astro';
import AtomPickerSheet from '../../components/AtomPickerSheet.astro';
import NodeDetailSheet from '../../components/NodeDetailSheet.astro';
---

<MobileLayout title="Compose" showBack={true} backHref="/mobile/compositions">
  <div style="margin: -16px; margin-top: -16px;">
    <CompositionCanvas />
  </div>

  <!-- FAB button to add atoms -->
  <button id="add-atom-fab" class="compose-fab" title="Add atom">+</button>

  <!-- Atom picker bottom sheet -->
  <AtomPickerSheet />

  <!-- Node detail bottom sheet -->
  <NodeDetailSheet />
</MobileLayout>

<script>
  import {
    saveComposition,
    getComposition,
    addAtomToComposition,
    buildNodes,
    buildEdges,
    loadAtomsMap,
    updateNodePositions,
    removeAtomFromComposition,
  } from '../../scripts/composition-store';
  import { createRoute, deleteRoute } from '../../scripts/routing-engine';
  import {
    createEmptyComposition,
    MAX_ATOMS_PER_COMPOSITION,
  } from '../../scripts/composition-types';
  import { getAtom } from '../../scripts/db';
  import type { Node, Edge } from 'reactflow';

  let currentComposition = createEmptyComposition('Untitled Composition');
  let atomsMap = new Map();

  // Load composition from URL parameter or create new
  async function initComposition() {
    atomsMap = await loadAtomsMap();

    const params = new URLSearchParams(window.location.search);
    const compId = params.get('id');

    if (compId) {
      const loaded = await getComposition(compId);
      if (loaded) {
        currentComposition = loaded;
        await refreshCanvas();
        return;
      }
    }

    // New composition - canvas starts empty
    updateFabState();
  }

  // Refresh React Flow canvas from composition data
  async function refreshCanvas() {
    const nodes = await buildNodes(currentComposition, atomsMap);
    const edges = buildEdges(currentComposition);

    // Update React canvas via global setters (from CompositionCanvas)
    if ((window as any).__canvasSetNodes) {
      (window as any).__canvasSetNodes(nodes);
    }
    if ((window as any).__canvasSetEdges) {
      (window as any).__canvasSetEdges(edges);
    }
    updateFabState();
  }

  // FAB button: open atom picker
  const fab = document.getElementById('add-atom-fab')!;
  fab.addEventListener('click', () => {
    const atLimit = currentComposition.atoms.length >= MAX_ATOMS_PER_COMPOSITION;
    window.dispatchEvent(new CustomEvent('eoe:open-atom-picker', {
      detail: { atLimit }
    }));
  });

  // Handle atom selection from picker
  window.addEventListener('eoe:add-atom', async (e: Event) => {
    const customEvent = e as CustomEvent;
    const { atomSlug } = customEvent.detail;
    const atomMeta = atomsMap.get(atomSlug);
    if (!atomMeta) {
      console.warn('[compose] Atom not found in cache:', atomSlug);
      return;
    }

    const updated = addAtomToComposition(currentComposition, atomSlug, atomMeta);
    if (!updated) {
      // Limit reached
      showToast('Maximum 5 atoms reached');
      return;
    }

    currentComposition = updated;
    await saveComposition(currentComposition);
    await refreshCanvas();

    showToast(`Added ${atomMeta.title}`);
  });

  // Update FAB state (disable at limit)
  function updateFabState() {
    const atLimit = currentComposition.atoms.length >= MAX_ATOMS_PER_COMPOSITION;
    fab.classList.toggle('disabled', atLimit);
  }

  // Toast notification helper
  function showToast(message: string) {
    const toast = document.getElementById('canvas-toast');
    if (toast) {
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2000);
    }
  }

  // Listen for node position changes from React Flow
  // The canvas dispatches this when nodes are dragged
  window.addEventListener('eoe:nodes-changed', async (e: Event) => {
    const customEvent = e as CustomEvent;
    const nodes = customEvent.detail?.nodes;
    if (nodes && currentComposition) {
      currentComposition = updateNodePositions(currentComposition, nodes);
      // Don't save on every drag - autosave in 05-04 handles this
    }
  });

  // Handle node tap -> open detail sheet
  window.addEventListener('eoe:node-tapped', ((e: CustomEvent) => {
    const { nodeId } = e.detail;
    window.dispatchEvent(new CustomEvent('eoe:open-node-detail', {
      detail: {
        nodeId,
        composition: currentComposition,
        atomsMap,
      }
    }));
  }) as EventListener);

  // Handle route creation
  window.addEventListener('eoe:create-route', (async (e: CustomEvent) => {
    const { sourceNodeId, sourceParam, targetNodeId, targetParam } = e.detail;

    currentComposition = createRoute(
      currentComposition,
      sourceNodeId,
      sourceParam,
      targetNodeId,
      targetParam,
    );

    await saveComposition(currentComposition);
    await refreshCanvas();

    // Notify detail sheet of updated composition
    window.dispatchEvent(new CustomEvent('eoe:composition-updated', {
      detail: { composition: currentComposition }
    }));

    // Find target atom name for toast
    const targetAtom = currentComposition.atoms.find(a => a.nodeId === targetNodeId);
    const targetName = targetAtom
      ? atomsMap.get(targetAtom.atomSlug)?.title || targetAtom.atomSlug
      : '???';
    showToast(`Routed ${sourceParam} -> ${targetName}.${targetParam}`);
  }) as EventListener);

  // Handle route deletion
  window.addEventListener('eoe:delete-route', (async (e: CustomEvent) => {
    const { routeId } = e.detail;

    currentComposition = deleteRoute(currentComposition, routeId);
    await saveComposition(currentComposition);
    await refreshCanvas();

    window.dispatchEvent(new CustomEvent('eoe:composition-updated', {
      detail: { composition: currentComposition }
    }));

    showToast('Route deleted');
  }) as EventListener);

  // Handle node removal
  window.addEventListener('eoe:remove-node', (async (e: CustomEvent) => {
    const { nodeId } = e.detail;

    currentComposition = removeAtomFromComposition(currentComposition, nodeId);
    await saveComposition(currentComposition);
    await refreshCanvas();

    showToast('Atom removed');
  }) as EventListener);

  // Handle composition state request (from detail sheet after changes)
  window.addEventListener('eoe:request-composition-state', (() => {
    window.dispatchEvent(new CustomEvent('eoe:composition-updated', {
      detail: { composition: currentComposition }
    }));
  }) as EventListener);

  // Initialize
  initComposition();
</script>

<style>
  :global(.mobile-main) {
    padding: 0 !important;
    max-width: none !important;
  }
</style>
