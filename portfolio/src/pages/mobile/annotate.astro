---
/**
 * Standalone annotation page.
 * Accessed via /mobile/annotate?atom=<slug>
 * Allows uploading an image, annotating it, and saving to the specified atom.
 */
import MobileLayout from '../../layouts/MobileLayout.astro';
import AnnotationCanvas from '../../components/AnnotationCanvas.astro';

// Note: atomSlug is read from URL query param on the client side.
// For SSG, we render a generic page that reads the param at runtime.
---

<MobileLayout title="Annotate" showBack={true} backHref="/mobile/gallery">
  <div id="annotation-page">
    <p id="atom-label" class="atom-label" style="display: none;">
      Annotating for: <strong id="atom-name"></strong>
    </p>

    <div id="annotation-mount"></div>
  </div>

  <script>
    import { AnnotationEngine } from '../../scripts/annotation-engine';
    import { saveScreenshot } from '../../scripts/db';

    // Read atom slug from URL query params
    const params = new URLSearchParams(window.location.search);
    const atomSlug = params.get('atom') || 'unassigned';

    // Show atom label
    const atomLabel = document.getElementById('atom-label');
    const atomName = document.getElementById('atom-name');
    if (atomLabel && atomName && atomSlug !== 'unassigned') {
      atomName.textContent = atomSlug;
      atomLabel.style.display = 'block';
    }

    // Mount the annotation component dynamically
    // Since we need to pass atomSlug at runtime, we create the component structure here
    const mount = document.getElementById('annotation-mount');
    if (mount) {
      // Create upload area
      mount.innerHTML = `
        <div class="annotation-wrapper" data-atom-slug="${atomSlug}">
          <div id="upload-area" class="upload-area">
            <label for="image-input" class="upload-label tap-target">
              <span class="upload-icon" style="font-size: 2rem; color: #6bb5ff;">+</span>
              <span style="font-size: 1rem; font-weight: 600; color: #ccc;">Tap to select image</span>
              <span style="font-size: 0.8rem; color: #666;">Photo, screenshot, or camera</span>
            </label>
            <input type="file" id="image-input" accept="image/*" capture="environment" style="display: none;" />
          </div>
          <div id="canvas-area" style="display: none;">
            <div class="annotation-toolbar" style="display: flex; align-items: center; gap: 4px; padding: 8px 12px; background: #111; border-bottom: 1px solid #222; position: sticky; top: 48px; z-index: 50;">
              <button id="pen-tool" class="tool-btn active" style="min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;border:none;background:#222;color:#6bb5ff;border-radius:8px;cursor:pointer;border:1px solid #6bb5ff;">&#9998;</button>
              <button id="text-tool" class="tool-btn" style="min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;border:none;background:#1a1a1a;color:#888;border-radius:8px;cursor:pointer;">T</button>
              <div style="width:1px;height:28px;background:#333;margin:0 4px;"></div>
              <button id="undo-btn" class="tool-btn" disabled style="min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;border:none;background:#1a1a1a;color:#888;border-radius:8px;cursor:pointer;opacity:0.3;">&#8617;</button>
              <button id="redo-btn" class="tool-btn" disabled style="min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;border:none;background:#1a1a1a;color:#888;border-radius:8px;cursor:pointer;opacity:0.3;">&#8618;</button>
              <div style="width:1px;height:28px;background:#333;margin:0 4px;"></div>
              <label style="font-size:0.75rem;color:#666;">W:</label>
              <input type="range" id="stroke-width" min="1" max="15" value="3" style="width:60px;height:44px;" />
              <div style="flex:1;"></div>
              <button id="save-btn" class="tool-btn" style="min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;border:none;background:#1a2a1a;color:#6bff6b;border-radius:8px;cursor:pointer;">&#10003;</button>
            </div>
            <canvas id="annotation-canvas" style="display:block;width:100%;background:#0a0a0a;touch-action:none;"></canvas>
          </div>
          <div id="save-confirmation" style="display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:12px 24px;background:#1a2a1a;border:1px solid #336633;border-radius:8px;color:#6bff6b;font-size:0.9rem;z-index:200;">Saved!</div>
        </div>
      `;

      // Initialize
      const imageInput = document.getElementById('image-input') as HTMLInputElement;
      const canvas = document.getElementById('annotation-canvas') as HTMLCanvasElement;
      const uploadArea = document.getElementById('upload-area')!;
      const canvasArea = document.getElementById('canvas-area')!;
      const penTool = document.getElementById('pen-tool')!;
      const textTool = document.getElementById('text-tool')!;
      const undoBtn = document.getElementById('undo-btn') as HTMLButtonElement;
      const redoBtn = document.getElementById('redo-btn') as HTMLButtonElement;
      const strokeWidthInput = document.getElementById('stroke-width') as HTMLInputElement;
      const saveBtn = document.getElementById('save-btn')!;
      const saveConfirmation = document.getElementById('save-confirmation')!;

      let engine: AnnotationEngine | null = null;

      imageInput.addEventListener('change', async () => {
        const file = imageInput.files?.[0];
        if (!file) return;

        engine = new AnnotationEngine({ canvas, strokeWidth: parseInt(strokeWidthInput.value, 10) });

        engine.onState((state) => {
          undoBtn.disabled = !state.canUndo;
          undoBtn.style.opacity = state.canUndo ? '1' : '0.3';
          redoBtn.disabled = !state.canRedo;
          redoBtn.style.opacity = state.canRedo ? '1' : '0.3';
          penTool.style.color = state.tool === 'pen' ? '#6bb5ff' : '#888';
          penTool.style.borderColor = state.tool === 'pen' ? '#6bb5ff' : 'transparent';
          textTool.style.color = state.tool === 'text' ? '#6bb5ff' : '#888';
          textTool.style.borderColor = state.tool === 'text' ? '#6bb5ff' : 'transparent';
        });

        await engine.loadImageFromFile(file);
        uploadArea.style.display = 'none';
        canvasArea.style.display = 'block';
      });

      penTool.addEventListener('click', () => engine?.setTool('pen'));
      textTool.addEventListener('click', () => engine?.setTool('text'));
      undoBtn.addEventListener('click', () => engine?.undo());
      redoBtn.addEventListener('click', () => engine?.redo());
      strokeWidthInput.addEventListener('input', () => engine?.setStrokeWidth(parseInt(strokeWidthInput.value, 10)));

      saveBtn.addEventListener('click', async () => {
        if (!engine) return;
        const imageBlob = await engine.exportAsWebP();
        await saveScreenshot({ atomSlug, imageBlob, createdAt: new Date().toISOString(), synced: false });
        saveConfirmation.style.display = 'flex';
        setTimeout(() => { saveConfirmation.style.display = 'none'; }, 2000);
        window.dispatchEvent(new CustomEvent('eoe:screenshots-updated', { detail: { atomSlug } }));
      });
    }
  </script>

  <style>
    .atom-label {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 16px;
    }

    .upload-area {
      padding: 32px 0;
    }

    .upload-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 48px 24px;
      border: 2px dashed #333;
      border-radius: 12px;
      cursor: pointer;
    }
  </style>
</MobileLayout>
