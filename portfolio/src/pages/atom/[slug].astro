---
import Base from '../../layouts/Base.astro';
import P5Sketch from '../../components/P5Sketch.astro';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const atomsDir = path.resolve('./public/atoms');
  if (!fs.existsSync(atomsDir)) return [];

  const atoms = fs.readdirSync(atomsDir, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => d.name);

  return atoms.map(slug => ({
    params: { slug },
    props: { slug }
  }));
}

const { slug } = Astro.params;

// Parse atom metadata
const parts = slug.match(/^(\d{4}-\d{2}-\d{2})-(.+)$/);
const date = parts ? parts[1] : '';
const name = parts ? parts[2] : slug;

// Read NOTES.md if exists
const notesPath = path.resolve(`./public/atoms/${slug}/NOTES.md`);
let notes = '';
let stage = 'idea';
if (fs.existsSync(notesPath)) {
  notes = fs.readFileSync(notesPath, 'utf8');
  const stageMatch = notes.match(/\*\*Stage:\*\*\s*(\w+)/);
  if (stageMatch) stage = stageMatch[1];
}
---

<Base title={name}>
  <div style="margin-bottom: 1rem;">
    <a href="/" style="color: #666; font-size: 0.85rem;">&larr; Back to Gallery</a>
  </div>

  <h1 style="margin-bottom: 0.5rem; font-size: 1.5rem;">{name}</h1>
  <p style="color: #666; margin-bottom: 2rem; font-size: 0.85rem;">
    {date} &middot; {stage}
  </p>

  <P5Sketch atomName={slug} />

  {notes && (
    <details style="margin-top: 2rem;">
      <summary style="cursor: pointer; color: #888;">Notes</summary>
      <pre style="margin-top: 1rem; padding: 1rem; background: #151515; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap;">{notes}</pre>
    </details>
  )}
</Base>
