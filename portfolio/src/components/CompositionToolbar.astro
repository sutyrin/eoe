---
/**
 * CompositionToolbar: Fixed toolbar on composition canvas.
 *
 * Shows:
 * - Undo/Redo buttons (disabled when history empty)
 * - Composition name (tappable to edit)
 * - Save status indicator
 * - Delete composition action
 */
---

<div class="comp-toolbar" id="comp-toolbar">
  <div class="toolbar-left">
    <button id="undo-btn" class="toolbar-btn" disabled title="Undo">
      <span class="toolbar-btn-icon">&#8630;</span>
    </button>
    <button id="redo-btn" class="toolbar-btn" disabled title="Redo">
      <span class="toolbar-btn-icon">&#8631;</span>
    </button>
  </div>

  <div class="toolbar-center">
    <button id="comp-name-btn" class="comp-name-btn" title="Tap to rename">
      <span id="comp-name-text">Untitled</span>
    </button>
    <span id="save-indicator" class="save-indicator" style="display: none;">Saved</span>
  </div>

  <div class="toolbar-right">
    <button id="save-snapshot-btn" class="toolbar-btn toolbar-primary" title="Save snapshot">
      <span class="toolbar-btn-icon" style="font-size: 0.85rem;">&#128190;</span>
    </button>
    <button id="comp-delete-btn" class="toolbar-btn toolbar-danger" title="Delete composition">
      <span class="toolbar-btn-icon" style="font-size: 0.85rem;">Del</span>
    </button>
  </div>
</div>

<script>
  import { flushAutosave } from '../scripts/composition-autosave';

  const undoBtn = document.getElementById('undo-btn') as HTMLButtonElement;
  const redoBtn = document.getElementById('redo-btn') as HTMLButtonElement;
  const nameBtn = document.getElementById('comp-name-btn')!;
  const nameText = document.getElementById('comp-name-text')!;
  const saveIndicator = document.getElementById('save-indicator')!;
  const saveSnapshotBtn = document.getElementById('save-snapshot-btn')!;
  const deleteBtn = document.getElementById('comp-delete-btn')!;

  // Undo button
  undoBtn.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('eoe:undo'));
  });

  // Redo button
  redoBtn.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('eoe:redo'));
  });

  // Rename composition
  nameBtn.addEventListener('click', () => {
    const currentName = nameText.textContent || 'Untitled';
    const newName = prompt('Composition name:', currentName);
    if (newName !== null && newName.trim()) {
      window.dispatchEvent(new CustomEvent('eoe:rename-composition', {
        detail: { name: newName.trim() }
      }));
    }
  });

  // Save snapshot
  saveSnapshotBtn.addEventListener('click', async () => {
    await flushAutosave(); // Ensure draft is saved first
    window.dispatchEvent(new CustomEvent('eoe:save-snapshot'));
  });

  // Delete composition
  deleteBtn.addEventListener('click', async () => {
    if (confirm('Delete this composition? This cannot be undone.')) {
      await flushAutosave(); // Save any pending changes first
      window.dispatchEvent(new CustomEvent('eoe:delete-composition'));
    }
  });

  // Update undo/redo button states
  window.addEventListener('eoe:history-changed', ((e: CustomEvent) => {
    const { canUndo, canRedo } = e.detail;
    undoBtn.disabled = !canUndo;
    redoBtn.disabled = !canRedo;
  }) as EventListener);

  // Update composition name
  window.addEventListener('eoe:composition-name-changed', ((e: CustomEvent) => {
    nameText.textContent = e.detail.name;
  }) as EventListener);

  // Save indicator
  window.addEventListener('eoe:composition-saved', () => {
    saveIndicator.style.display = 'inline';
    saveIndicator.textContent = 'Saved';
    setTimeout(() => {
      saveIndicator.style.display = 'none';
    }, 1500);
  });

  // Flush autosave on page unload
  window.addEventListener('beforeunload', () => {
    flushAutosave();
  });

  // Flush on visibilitychange (mobile: app backgrounded)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      flushAutosave();
    }
  });
</script>

<style>
  .comp-toolbar {
    position: fixed;
    top: 48px; /* Below mobile header */
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 12px;
    background: rgba(10, 10, 10, 0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-bottom: 1px solid #1a1a1a;
    z-index: 50;
    min-height: 40px;
  }

  .toolbar-left, .toolbar-right {
    display: flex;
    gap: 4px;
  }

  .toolbar-center {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    justify-content: center;
    min-width: 0;
  }

  .toolbar-btn {
    width: 36px;
    height: 36px;
    border: 1px solid #333;
    background: #1a1a1a;
    color: #ccc;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
  }

  .toolbar-btn:disabled {
    opacity: 0.3;
    pointer-events: none;
  }

  .toolbar-btn:active:not(:disabled) {
    background: #333;
  }

  .toolbar-primary {
    border-color: #6bb5ff40;
    color: #6bb5ff;
  }

  .toolbar-primary:active {
    background: #6bb5ff20 !important;
  }

  .toolbar-danger {
    border-color: #ff444440;
    color: #ff6666;
  }

  .toolbar-danger:active {
    background: #ff444420 !important;
  }

  .toolbar-btn-icon {
    font-size: 1.1rem;
    line-height: 1;
  }

  .comp-name-btn {
    border: none;
    background: none;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-family: inherit;
  }

  .comp-name-btn:active {
    background: #222;
  }

  .save-indicator {
    font-size: 0.7rem;
    color: #6bff6b;
    font-weight: 600;
  }
</style>
