---
// OfflineIndicator: Shows a small banner when device is offline
// Listens for eoe:offline-status custom events from offline-status.ts
---
<div id="offline-indicator" class="offline-indicator" style="display: none;">
  <span class="offline-dot"></span>
  <span class="offline-text">Offline</span>
</div>

<div id="storage-warning" class="storage-warning" style="display: none;">
  <span class="storage-text">Storage nearly full</span>
</div>

<div id="sync-status" class="sync-status" style="display: none;">
  <span class="sync-dot"></span>
  <span class="sync-text"></span>
</div>

<script>
  // Listen for offline status changes
  window.addEventListener('eoe:offline-status', (e: CustomEvent) => {
    const indicator = document.getElementById('offline-indicator');
    if (indicator) {
      indicator.style.display = e.detail.isOnline ? 'none' : 'flex';
    }
  });

  // Listen for storage warnings
  window.addEventListener('eoe:storage-status', (e: CustomEvent) => {
    const warning = document.getElementById('storage-warning');
    if (warning) {
      warning.style.display = e.detail.warning ? 'flex' : 'none';
      const text = warning.querySelector('.storage-text');
      if (text) {
        text.textContent = `Storage: ${e.detail.usageMB}MB / ${e.detail.quotaMB}MB`;
      }
    }
  });

  // Show initial offline state immediately (don't wait for event)
  if (!navigator.onLine) {
    const indicator = document.getElementById('offline-indicator');
    if (indicator) indicator.style.display = 'flex';
  }

  // Check unsynced compositions and snapshots (Phase 6)
  async function checkSyncStatus() {
    try {
      const { getUnsyncedCount } = await import('../scripts/composition-store');
      const compCount = await getUnsyncedCount();

      // Also check unsynced snapshots
      let snapCount = 0;
      try {
        const { getUnsyncedSnapshots } = await import('../scripts/db');
        const unsynced = await getUnsyncedSnapshots();
        snapCount = unsynced.length;
      } catch { /* snapshots store may not exist */ }

      const totalUnsynced = compCount + snapCount;
      const syncEl = document.getElementById('sync-status');
      const syncText = syncEl?.querySelector('.sync-text');
      const syncDot = syncEl?.querySelector('.sync-dot') as HTMLElement;

      if (syncEl && syncText) {
        if (totalUnsynced > 0) {
          syncText.textContent = `${totalUnsynced} item${totalUnsynced !== 1 ? 's' : ''} not backed up`;
          if (syncDot) syncDot.style.background = '#ffb56b'; // Orange: pending
          syncEl.style.display = 'flex';
        } else {
          syncText.textContent = 'All backed up';
          if (syncDot) syncDot.style.background = '#6bff6b'; // Green: synced
          syncEl.style.display = 'flex';
          // Hide after 3 seconds when fully synced
          setTimeout(() => {
            if (syncEl) syncEl.style.display = 'none';
          }, 3000);
        }
      }
    } catch {
      // Stores may not be initialized yet
    }
  }

  // Feature flag for Phase 6 (enabled)
  const SHOW_SYNC_STATUS = true; // Phase 6: enabled
  if (SHOW_SYNC_STATUS) {
    // Check sync status periodically (every 30 seconds)
    setInterval(checkSyncStatus, 30000);
    // Initial check after delay (let IndexedDB initialize)
    setTimeout(checkSyncStatus, 2000);

    // Enable auto-backup on app close
    import('../scripts/backup-client').then(({ enableAutoBackup }) => {
      enableAutoBackup();
      console.log('[sync] Auto-backup enabled');
    }).catch(() => {
      // Module not available yet
    });

    // Listen for backup status changes
    window.addEventListener('eoe:backup-status', ((e: CustomEvent) => {
      const syncEl = document.getElementById('sync-status');
      const syncText = syncEl?.querySelector('.sync-text');
      const syncDot = syncEl?.querySelector('.sync-dot') as HTMLElement;

      if (!syncEl || !syncText) return;

      const { status, lastBackupTime } = e.detail;

      switch (status) {
        case 'backing-up':
          syncText.textContent = 'Backing up...';
          if (syncDot) {
            syncDot.style.background = '#6bb5ff'; // Blue: active
            syncDot.classList.add('active');
          }
          syncEl.style.display = 'flex';
          break;
        case 'success':
          syncText.textContent = 'Backup complete';
          if (syncDot) {
            syncDot.style.background = '#6bff6b'; // Green
            syncDot.classList.remove('active');
          }
          syncEl.style.display = 'flex';
          setTimeout(() => { syncEl.style.display = 'none'; }, 3000);
          break;
        case 'error':
          syncText.textContent = 'Backup failed';
          if (syncDot) {
            syncDot.style.background = '#ff6b6b'; // Red
            syncDot.classList.remove('active');
          }
          syncEl.style.display = 'flex';
          break;
      }
    }) as EventListener);
  }
</script>

<style>
  .offline-indicator {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px;
    background: #333;
    color: #fff;
    font-size: 0.8rem;
    z-index: 1000;
  }

  .offline-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ff6b6b;
  }

  .storage-warning {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    background: #553300;
    color: #ffcc00;
    font-size: 0.75rem;
    z-index: 1000;
  }

  .sync-status {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 6px;
    background: #1a3a1a;
    color: #aad;
    font-size: 0.75rem;
    z-index: 999;
    transition: opacity 0.3s ease;
  }

  .sync-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #ffb56b;
    transition: background 0.3s ease;
  }

  @keyframes sync-pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .sync-dot.active {
    animation: sync-pulse 1.5s ease-in-out infinite;
  }
</style>
