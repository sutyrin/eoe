---
/**
 * NotesEditor: Inline textarea for editing NOTES.md content on mobile.
 * Provides a simple editing experience with Save button.
 * Covers IDEA-04: quick-edit NOTES.md on mobile.
 */
export interface Props {
  atomSlug: string;
  initialNotes: string;
}

const { atomSlug, initialNotes } = Astro.props;
---

<div class="notes-editor" data-atom-slug={atomSlug}>
  <div class="notes-editor-header">
    <h3 class="notes-heading">Notes</h3>
    <div class="notes-mode-toggle">
      <button class="mode-btn active" id="view-mode-btn">View</button>
      <button class="mode-btn" id="edit-mode-btn">Edit</button>
    </div>
  </div>

  <!-- View mode (default) -->
  <div id="notes-view-mode" class="notes-view-mode">
    {initialNotes ? (
      <pre class="notes-content" id="notes-display">{initialNotes}</pre>
    ) : (
      <p class="notes-empty">No notes for this atom. Tap Edit to add some.</p>
    )}
  </div>

  <!-- Edit mode -->
  <div id="notes-edit-mode" class="notes-edit-mode" style="display: none;">
    <textarea
      id="notes-textarea"
      class="notes-textarea"
      rows="12"
      placeholder="Write your process notes here..."
    >{initialNotes}</textarea>
    <div class="notes-edit-actions">
      <button id="save-notes-btn" class="btn btn-primary" style="flex: 1;">Save</button>
      <button id="cancel-notes-btn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
    </div>
    <div id="notes-save-status" class="notes-save-status" style="display: none;">
      Saved!
    </div>
  </div>
</div>

<script>
  import { saveAtomNotes, loadAtomNotes } from '../scripts/notes-editor';

  async function initNotesEditor() {
    const container = document.querySelector('.notes-editor') as HTMLElement;
    if (!container) return;

    const atomSlug = container.dataset.atomSlug || '';

    const viewModeBtn = document.getElementById('view-mode-btn')!;
    const editModeBtn = document.getElementById('edit-mode-btn')!;
    const viewMode = document.getElementById('notes-view-mode')!;
    const editMode = document.getElementById('notes-edit-mode')!;
    const textarea = document.getElementById('notes-textarea') as HTMLTextAreaElement;
    const saveBtn = document.getElementById('save-notes-btn')!;
    const cancelBtn = document.getElementById('cancel-notes-btn')!;
    const saveStatus = document.getElementById('notes-save-status')!;
    const notesDisplay = document.getElementById('notes-display');

    // Load latest notes from IndexedDB (may have been edited previously)
    const storedNotes = await loadAtomNotes(atomSlug);
    if (storedNotes) {
      textarea.value = storedNotes;
      if (notesDisplay) {
        notesDisplay.textContent = storedNotes;
      }
    }

    // Switch to edit mode
    editModeBtn.addEventListener('click', () => {
      viewMode.style.display = 'none';
      editMode.style.display = 'block';
      viewModeBtn.classList.remove('active');
      editModeBtn.classList.add('active');
      textarea.focus();
    });

    // Switch to view mode (cancel)
    function switchToViewMode() {
      editMode.style.display = 'none';
      viewMode.style.display = 'block';
      editModeBtn.classList.remove('active');
      viewModeBtn.classList.add('active');
    }

    cancelBtn.addEventListener('click', () => {
      // Revert textarea to last saved value
      const currentDisplay = notesDisplay?.textContent || '';
      textarea.value = currentDisplay;
      switchToViewMode();
    });

    // Save notes
    saveBtn.addEventListener('click', async () => {
      const newNotes = textarea.value;
      const success = await saveAtomNotes(atomSlug, newNotes);

      if (success) {
        // Update view mode display
        if (notesDisplay) {
          notesDisplay.textContent = newNotes;
        } else {
          // If there was no notes-display (was empty), recreate view
          viewMode.innerHTML = `<pre class="notes-content" id="notes-display">${escapeHtml(newNotes)}</pre>`;
        }

        // Show save confirmation
        saveStatus.style.display = 'block';
        setTimeout(() => {
          saveStatus.style.display = 'none';
        }, 2000);

        switchToViewMode();
      }
    });
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  initNotesEditor();
</script>

<style>
  .notes-editor {
    margin: 16px 0;
  }

  .notes-editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .notes-heading {
    font-size: 1rem;
    color: #fff;
    font-weight: 600;
  }

  .notes-mode-toggle {
    display: flex;
    gap: 0;
    border: 1px solid #333;
    border-radius: 6px;
    overflow: hidden;
  }

  .mode-btn {
    padding: 6px 14px;
    border: none;
    background: #1a1a1a;
    color: #666;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    min-height: 36px;
  }

  .mode-btn.active {
    background: #333;
    color: #6bb5ff;
  }

  .mode-btn:active {
    background: #222;
  }

  .notes-content {
    padding: 16px;
    background: #151515;
    border-radius: 8px;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #ccc;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-height: 400px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .notes-empty {
    color: #555;
    font-size: 0.85rem;
    font-style: italic;
  }

  .notes-textarea {
    width: 100%;
    padding: 16px;
    font-size: 16px; /* Prevents iOS zoom */
    background: #151515;
    border: 1px solid #333;
    border-radius: 8px;
    color: #e0e0e0;
    resize: vertical;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    min-height: 200px;
  }

  .notes-textarea:focus {
    border-color: #6bb5ff;
    outline: none;
  }

  .notes-edit-actions {
    display: flex;
    gap: 12px;
    margin-top: 12px;
  }

  .notes-save-status {
    margin-top: 8px;
    padding: 8px;
    text-align: center;
    color: #6bff6b;
    font-size: 0.85rem;
    background: #1a2a1a;
    border-radius: 6px;
  }
</style>
