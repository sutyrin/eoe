---
/**
 * ConflictResolver: Per-item conflict resolution when restoring.
 *
 * When local data differs from backup data, this component shows
 * a notification for each conflict and lets the user choose:
 * - Keep local version
 * - Use backup version
 *
 * Conflicts are detected by comparing updatedAt timestamps.
 * If both have changed since last sync, it's a conflict.
 */
---

<div id="conflict-resolver" class="conflict-resolver" style="display: none;">
  <div class="conflict-header">
    <span class="conflict-icon">!</span>
    <span class="conflict-title">Conflict Detected</span>
  </div>
  <div id="conflict-body" class="conflict-body">
    <!-- Filled dynamically -->
  </div>
</div>

<script>
  const resolver = document.getElementById('conflict-resolver')!;
  const conflictBody = document.getElementById('conflict-body')!;

  interface ConflictItem {
    type: 'atom' | 'composition' | 'snapshot';
    name: string;
    localUpdated: string;
    backupUpdated: string;
    localData: unknown;
    backupData: unknown;
  }

  let conflicts: ConflictItem[] = [];
  let resolvedCount = 0;

  // Show conflicts
  window.addEventListener('eoe:show-conflicts', ((e: CustomEvent) => {
    conflicts = e.detail.conflicts || [];
    resolvedCount = 0;

    if (conflicts.length === 0) return;

    renderConflicts();
    resolver.style.display = 'block';
  }) as EventListener);

  function renderConflicts() {
    conflictBody.innerHTML = '';

    for (let i = 0; i < conflicts.length; i++) {
      const conflict = conflicts[i];
      const localDate = new Date(conflict.localUpdated).toLocaleString();
      const backupDate = new Date(conflict.backupUpdated).toLocaleString();

      const item = document.createElement('div');
      item.className = 'conflict-item';
      item.id = `conflict-${i}`;
      item.innerHTML = `
        <div class="conflict-item-name">
          <span class="conflict-type-badge">${conflict.type.toUpperCase()}</span>
          ${conflict.name}
        </div>
        <div class="conflict-item-details">
          <div class="conflict-version">
            <span class="conflict-label">Local:</span>
            <span class="conflict-date">${localDate}</span>
          </div>
          <div class="conflict-version">
            <span class="conflict-label">Backup:</span>
            <span class="conflict-date">${backupDate}</span>
          </div>
        </div>
        <div class="conflict-actions">
          <button class="conflict-btn conflict-btn-local" data-index="${i}" data-choice="local">Keep Local</button>
          <button class="conflict-btn conflict-btn-backup" data-index="${i}" data-choice="backup">Use Backup</button>
        </div>
      `;
      conflictBody.appendChild(item);
    }

    // Button handlers
    conflictBody.querySelectorAll('.conflict-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const el = e.target as HTMLElement;
        const index = parseInt(el.getAttribute('data-index')!);
        const choice = el.getAttribute('data-choice')!;

        resolveConflict(index, choice as 'local' | 'backup');
      });
    });
  }

  async function resolveConflict(index: number, choice: 'local' | 'backup') {
    const conflict = conflicts[index];
    const itemEl = document.getElementById(`conflict-${index}`);

    if (choice === 'backup') {
      // Write backup data to IndexedDB
      window.dispatchEvent(new CustomEvent('eoe:apply-conflict-resolution', {
        detail: {
          type: conflict.type,
          data: conflict.backupData,
          choice: 'backup',
        }
      }));
    }
    // If 'local', do nothing (local data already in place)

    // Mark as resolved in UI
    if (itemEl) {
      itemEl.classList.add('conflict-resolved');
      itemEl.innerHTML = `
        <div class="conflict-resolved-text">
          <span class="conflict-type-badge">${conflict.type.toUpperCase()}</span>
          ${conflict.name}: kept ${choice} version
        </div>
      `;
    }

    resolvedCount++;

    // All resolved?
    if (resolvedCount >= conflicts.length) {
      setTimeout(() => {
        resolver.style.display = 'none';
        window.dispatchEvent(new CustomEvent('eoe:conflicts-resolved'));
      }, 1500);
    }
  }
</script>

<style>
  .conflict-resolver {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1a1a1a;
    border-top: 2px solid #ffb56b;
    z-index: 180;
    max-height: 60vh;
    overflow-y: auto;
    padding-bottom: env(safe-area-inset-bottom, 0);
  }

  .conflict-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 20px;
    border-bottom: 1px solid #333;
  }

  .conflict-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #ffb56b;
    color: #0a0a0a;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
  }

  .conflict-title {
    font-size: 1rem;
    font-weight: 700;
    color: #ffb56b;
  }

  .conflict-body {
    padding: 12px 20px;
  }

  .conflict-item {
    padding: 12px 0;
    border-bottom: 1px solid #222;
  }

  .conflict-item-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: #ccc;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .conflict-type-badge {
    font-size: 0.65rem;
    font-weight: 700;
    color: #ffb56b;
    background: rgba(255, 181, 107, 0.15);
    padding: 2px 6px;
    border-radius: 3px;
    letter-spacing: 0.5px;
  }

  .conflict-item-details {
    display: flex;
    gap: 20px;
    margin-bottom: 10px;
  }

  .conflict-version {
    font-size: 0.8rem;
  }

  .conflict-label {
    color: #666;
    margin-right: 4px;
  }

  .conflict-date {
    color: #aaa;
  }

  .conflict-actions {
    display: flex;
    gap: 8px;
  }

  .conflict-btn {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    min-height: 40px;
    -webkit-tap-highlight-color: transparent;
  }

  .conflict-btn-local {
    background: #333;
    color: #ccc;
  }

  .conflict-btn-backup {
    background: #6bb5ff;
    color: #0a0a0a;
  }

  .conflict-resolved {
    opacity: 0.5;
  }

  .conflict-resolved-text {
    font-size: 0.85rem;
    color: #6bff6b;
    display: flex;
    align-items: center;
    gap: 8px;
  }
</style>
