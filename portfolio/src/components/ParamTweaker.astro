---
/**
 * ParamTweaker: Renders sliders and number inputs for atom config.json parameters.
 * Changes save immediately to IndexedDB. Live preview deferred to Phase 5.
 */
export interface Props {
  atomSlug: string;
  configJson: string;
}

const { atomSlug, configJson } = Astro.props;
---

<div class="param-tweaker" data-atom-slug={atomSlug} data-config-json={configJson}>
  <div class="param-info-banner">
    Changes saved locally. Preview on desktop with <code>eoe dev</code>.
  </div>

  <div id="param-list" class="param-list">
    <!-- Parameters rendered by client-side script -->
    <p class="param-loading">Loading parameters...</p>
  </div>

  <div class="param-actions">
    <button id="reset-params" class="btn btn-secondary" style="width: 100%;">
      Reset to Original
    </button>
  </div>
</div>

<script>
  import { parseControllers, applyOverrides, saveParamChange, resetOverrides, type ParamDef } from '../scripts/param-engine';

  async function initTweaker() {
    const container = document.querySelector('.param-tweaker') as HTMLElement;
    if (!container) return;

    const atomSlug = container.dataset.atomSlug || '';
    const configJson = container.dataset.configJson || '{}';
    const paramList = document.getElementById('param-list');
    if (!paramList) return;

    // Parse and apply saved overrides
    let params = parseControllers(configJson);
    params = await applyOverrides(atomSlug, params);

    if (params.length === 0) {
      paramList.innerHTML = '<p style="color: #555; font-style: italic;">No adjustable parameters in config.json.</p>';
      return;
    }

    // Render parameter controls
    paramList.innerHTML = '';
    for (const param of params) {
      const row = createParamRow(param, atomSlug);
      paramList.appendChild(row);
    }

    // Reset button
    const resetBtn = document.getElementById('reset-params');
    if (resetBtn) {
      resetBtn.addEventListener('click', async () => {
        await resetOverrides(atomSlug);
        // Re-parse original params (no overrides)
        const original = parseControllers(configJson);
        paramList.innerHTML = '';
        for (const param of original) {
          const row = createParamRow(param, atomSlug);
          paramList.appendChild(row);
        }
      });
    }
  }

  function createParamRow(param: ParamDef, atomSlug: string): HTMLElement {
    const row = document.createElement('div');
    row.className = 'param-row';

    // Label + value display
    const header = document.createElement('div');
    header.className = 'param-header';

    const label = document.createElement('span');
    label.className = 'param-name';
    label.textContent = param.name;

    const valueDisplay = document.createElement('span');
    valueDisplay.className = 'param-value';
    valueDisplay.textContent = formatValue(param.currentValue, param.step);

    header.appendChild(label);
    header.appendChild(valueDisplay);

    // Slider
    const slider = document.createElement('input');
    slider.type = 'range';
    slider.className = 'param-slider';
    slider.min = String(param.min);
    slider.max = String(param.max);
    slider.step = String(param.step);
    slider.value = String(param.currentValue);

    // Number input
    const numInput = document.createElement('input');
    numInput.type = 'number';
    numInput.className = 'param-number';
    numInput.min = String(param.min);
    numInput.max = String(param.max);
    numInput.step = String(param.step);
    numInput.value = String(param.currentValue);

    // Slider change handler â€” instant feedback
    slider.addEventListener('input', async () => {
      const val = parseFloat(slider.value);
      valueDisplay.textContent = formatValue(val, param.step);
      numInput.value = String(val);
      await saveParamChange(atomSlug, param.name, val);
    });

    // Number input change handler
    numInput.addEventListener('change', async () => {
      let val = parseFloat(numInput.value);
      // Clamp to range
      val = Math.max(param.min, Math.min(param.max, val));
      numInput.value = String(val);
      slider.value = String(val);
      valueDisplay.textContent = formatValue(val, param.step);
      await saveParamChange(atomSlug, param.name, val);
    });

    // Changed indicator
    if (param.currentValue !== param.originalValue) {
      row.classList.add('param-changed');
    }

    row.appendChild(header);
    row.appendChild(slider);
    row.appendChild(numInput);

    return row;
  }

  function formatValue(value: number, step: number): string {
    if (step >= 1) return String(Math.round(value));
    if (step >= 0.1) return value.toFixed(1);
    if (step >= 0.01) return value.toFixed(2);
    return value.toFixed(4);
  }

  // Initialize when DOM is ready
  initTweaker();
</script>

<style>
  .param-tweaker {
    padding: 8px 0;
  }

  .param-info-banner {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    font-size: 0.8rem;
    color: #888;
    text-align: center;
  }

  .param-info-banner code {
    color: #6bb5ff;
    font-family: 'SF Mono', monospace;
  }

  .param-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 24px;
  }

  .param-loading {
    color: #555;
    text-align: center;
    font-style: italic;
  }

  .param-row {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 12px;
    background: #111;
    border-radius: 8px;
    border-left: 3px solid transparent;
  }

  .param-row.param-changed {
    border-left-color: #6bb5ff;
  }

  .param-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .param-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: #ccc;
  }

  .param-value {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6bb5ff;
    font-family: 'SF Mono', monospace;
  }

  .param-slider {
    width: 100%;
    height: 44px;
    -webkit-appearance: none;
    background: transparent;
    cursor: pointer;
  }

  .param-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #6bb5ff;
    cursor: pointer;
    margin-top: -12px;
    box-shadow: 0 0 0 2px transparent;
    transition: box-shadow 0.2s;
  }

  .param-slider:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 4px rgba(107, 181, 255, 0.3);
  }

  .param-slider::-webkit-slider-runnable-track {
    height: 4px;
    background: #333;
    border-radius: 2px;
  }

  .param-slider::-moz-range-thumb {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #6bb5ff;
    cursor: pointer;
    border: none;
    box-shadow: 0 0 0 2px transparent;
    transition: box-shadow 0.2s;
  }

  .param-slider:focus::-moz-range-thumb {
    box-shadow: 0 0 0 4px rgba(107, 181, 255, 0.3);
  }

  .param-slider::-moz-range-track {
    height: 4px;
    background: #333;
    border-radius: 2px;
    border: none;
  }

  .param-number {
    width: 100%;
    padding: 8px 12px;
    font-size: 16px; /* Prevents iOS zoom */
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    color: #e0e0e0;
    font-family: 'SF Mono', monospace;
    text-align: right;
    transition: border-color 0.2s;
  }

  .param-number::placeholder {
    color: #555;
  }

  .param-number:focus {
    border-color: #6bb5ff;
    outline: 2px solid rgba(107, 181, 255, 0.3);
    outline-offset: -1px;
  }

  /* Number input spinner buttons styling */
  .param-number::-webkit-outer-spin-button,
  .param-number::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .param-number[type=number] {
    -moz-appearance: textfield;
  }

  .param-actions {
    padding-top: 8px;
  }
</style>
