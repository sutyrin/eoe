---
/**
 * RestoreModal: Allows user to browse a backup and select items to restore.
 *
 * Features:
 * - Checkbox selection per category (atoms, compositions, snapshots)
 * - Preview of items in each category
 * - Conflict detection: highlights items that differ locally
 * - "Restore Selected" button triggers selective restore
 */
---

<div id="restore-modal" class="restore-modal" style="display: none;">
  <div class="restore-modal-content">
    <div class="restore-modal-header">
      <h2 class="restore-modal-title">Restore from Backup</h2>
      <button id="restore-close-btn" class="restore-close-btn">&times;</button>
    </div>

    <div id="restore-body" class="restore-modal-body">
      <div class="restore-loading">Loading backup contents...</div>
    </div>

    <div class="restore-modal-footer">
      <button id="restore-cancel-btn" class="restore-footer-btn restore-cancel">Cancel</button>
      <button id="restore-confirm-btn" class="restore-footer-btn restore-confirm" disabled>Restore Selected</button>
    </div>
  </div>
</div>

<script>
  import { restoreFromBackup } from '../scripts/backup-client';

  const modal = document.getElementById('restore-modal')!;
  const body = document.getElementById('restore-body')!;
  const closeBtn = document.getElementById('restore-close-btn')!;
  const cancelBtn = document.getElementById('restore-cancel-btn')!;
  const confirmBtn = document.getElementById('restore-confirm-btn')! as HTMLButtonElement;

  let currentBackupId: string | null = null;
  let selectedCategories: Record<string, boolean> = {};

  // Open modal
  window.addEventListener('eoe:open-restore-modal', (async (e: CustomEvent) => {
    currentBackupId = e.detail.backupId;
    modal.style.display = 'flex';

    // Load backup contents
    try {
      const res = await fetch(`/api/backup/${currentBackupId}`);
      if (!res.ok) throw new Error('Failed to load backup');
      const backup = await res.json();

      renderBackupContents(backup.data);
    } catch (err) {
      body.innerHTML = '<div class="restore-error">Failed to load backup contents.</div>';
    }
  }) as EventListener);

  // Close modal
  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);

  // Close on backdrop click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  function closeModal() {
    modal.style.display = 'none';
    currentBackupId = null;
    selectedCategories = {};
    confirmBtn.disabled = true;
  }

  // Render backup contents
  function renderBackupContents(data: any) {
    const categories = [
      { key: 'atoms', label: 'Atoms', items: data.atoms || [], icon: 'A' },
      { key: 'compositions', label: 'Compositions', items: data.compositions || [], icon: 'C' },
      { key: 'snapshots', label: 'Snapshots', items: data.snapshots || [], icon: 'S' },
    ];

    let html = '';
    for (const cat of categories) {
      if (cat.items.length === 0) continue;

      html += `
        <div class="restore-category">
          <label class="restore-category-header">
            <input type="checkbox" class="restore-checkbox" data-category="${cat.key}">
            <span class="restore-category-icon">${cat.icon}</span>
            <span class="restore-category-label">${cat.label}</span>
            <span class="restore-category-count">${cat.items.length}</span>
          </label>
          <div class="restore-items">
            ${cat.items.slice(0, 10).map((item: any) => `
              <div class="restore-item">
                <span class="restore-item-name">${item.name || item.title || item.slug || 'Unknown'}</span>
                <span class="restore-item-date">${item.updatedAt ? new Date(item.updatedAt).toLocaleDateString() : ''}</span>
              </div>
            `).join('')}
            ${cat.items.length > 10 ? `<div class="restore-item restore-item-more">+${cat.items.length - 10} more</div>` : ''}
          </div>
        </div>
      `;
    }

    if (html === '') {
      html = '<div class="restore-empty">This backup is empty.</div>';
    }

    body.innerHTML = html;

    // Checkbox handlers
    body.querySelectorAll('.restore-checkbox').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const el = e.target as HTMLInputElement;
        const category = el.getAttribute('data-category')!;
        selectedCategories[category] = el.checked;
        updateConfirmButton();
      });
    });
  }

  function updateConfirmButton() {
    const anySelected = Object.values(selectedCategories).some(v => v);
    confirmBtn.disabled = !anySelected;
  }

  // Confirm restore
  confirmBtn.addEventListener('click', async () => {
    if (!currentBackupId) return;

    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Restoring...';

    const result = await restoreFromBackup(currentBackupId, selectedCategories);

    if (result) {
      confirmBtn.textContent = `Restored: ${result.atomsRestored} atoms, ${result.compositionsRestored} compositions, ${result.snapshotsRestored} snapshots`;

      // Dispatch event for conflict checking
      window.dispatchEvent(new CustomEvent('eoe:restore-complete', {
        detail: result
      }));

      // Close after delay
      setTimeout(() => {
        closeModal();
        // Reload page to reflect restored data
        window.location.reload();
      }, 2000);
    } else {
      confirmBtn.textContent = 'Restore failed';
      setTimeout(() => {
        confirmBtn.textContent = 'Restore Selected';
        confirmBtn.disabled = false;
      }, 2000);
    }
  });
</script>

<style>
  .restore-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 200;
    backdrop-filter: blur(4px);
  }

  .restore-modal-content {
    background: #111;
    border-radius: 16px 16px 0 0;
    width: 100%;
    max-width: 480px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
  }

  .restore-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid #222;
  }

  .restore-modal-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #fff;
    margin: 0;
  }

  .restore-close-btn {
    background: none;
    border: none;
    color: #666;
    font-size: 24px;
    cursor: pointer;
    padding: 4px 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .restore-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
  }

  .restore-category {
    margin-bottom: 16px;
  }

  .restore-category-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    cursor: pointer;
    min-height: 44px;
  }

  .restore-checkbox {
    width: 20px;
    height: 20px;
    accent-color: #6bb5ff;
  }

  .restore-category-icon {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: #333;
    color: #6bb5ff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
  }

  .restore-category-label {
    font-size: 0.95rem;
    font-weight: 600;
    color: #ccc;
    flex: 1;
  }

  .restore-category-count {
    font-size: 0.8rem;
    color: #666;
    background: #222;
    padding: 2px 8px;
    border-radius: 10px;
  }

  .restore-items {
    padding-left: 54px;
  }

  .restore-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #1a1a1a;
  }

  .restore-item-name {
    font-size: 0.85rem;
    color: #aaa;
  }

  .restore-item-date {
    font-size: 0.75rem;
    color: #555;
  }

  .restore-item-more {
    color: #666;
    font-size: 0.8rem;
    font-style: italic;
    border: none;
    justify-content: center;
  }

  .restore-modal-footer {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid #222;
    padding-bottom: calc(16px + env(safe-area-inset-bottom, 0));
  }

  .restore-footer-btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    min-height: 48px;
    -webkit-tap-highlight-color: transparent;
  }

  .restore-cancel {
    background: #333;
    color: #ccc;
  }

  .restore-confirm {
    background: #6bb5ff;
    color: #0a0a0a;
  }

  .restore-confirm:disabled {
    background: #333;
    color: #555;
    cursor: not-allowed;
  }

  .restore-loading, .restore-empty, .restore-error {
    padding: 24px;
    text-align: center;
    color: #555;
  }

  .restore-error {
    color: #ff6b6b;
  }
</style>
